<html><head><base href="." /><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Drivy</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: Arial, sans-serif; }
  #map { height: 100vh; width: 100vw; }
  .station-popup { font-size: 14px; }
  .station-popup h3 { margin-bottom: 8px; color: #2c3e50; }
  .station-popup p { margin: 4px 0; }
  .price { font-weight: bold; color: #e74c3c; }
  .route-inputs {
    position: fixed;
    top: 20px;
    left: 5%;  
    width: 90%; 
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    max-height: 90vh; 
    overflow-y: auto; 
    transition: all 0.3s ease;
  }
  .route-inputs:hover {
    box-shadow: 0 6px 25px rgba(0,0,0,0.2);
  }
  .route-inputs input, .route-inputs select {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  .route-inputs input:focus, .route-inputs select:focus {
    border-color: #2c3e50;
    outline: none;
    box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
  }
  .route-inputs button {   
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    background: #0087c7;  
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .route-inputs button:disabled {
    cursor: wait;
    opacity: 0.8;
  }
  .route-inputs.collapsed {
  padding: 10px;
  height: auto;
}

.route-inputs.collapsed input,
.route-inputs.collapsed #calculateRouteBtn {
  display: none;
}

.route-inputs.collapsed #clearStationsBtn {
  display: block;
  margin-top: 0px;
}
  .sector-title {
    font-weight: 600;
    margin: 20px 0 15px;
    color: #2c3e50;
    padding-bottom: 8px;
    border-bottom: 2px solid #e9ecef;
  }
  .station-item {
    padding: 15px;
    margin: 8px 0;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.3s ease;
  }
  .station-item:hover {
    background: #f1f3f5;
    transform: translateX(3px);
  }
  .station-price {
    color: #e74c3c;
    font-weight: 600;
    font-size: 15px;
    margin: 5px 0;
  }
  .routes-modal {
    display: none;
  }
  .routes-modal.open {
    display: block;
  }
  .routes-modal .modal-buttons {
    margin-top: 20px;
    text-align: right;
  }
  .routes-modal .modal-buttons button {
    padding: 8px 16px;
    margin-left: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .routes-modal .modal-buttons .confirm {
    background: #2c3e50;
    color: white;
  }
  .routes-modal .modal-buttons .cancel {
    background: #e74c3c;
    color: white;
  }
  .route-preview {
    cursor: pointer;
  }
  .route-preview:hover {
    opacity: 0.8;
  }
  .route-preview.selected {
    opacity: 1;
    weight: 5;
  }
  .add-to-route-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    width: 100%;
  }
  .add-to-route-btn:hover {
    background: #219a52;
    transform: translateY(-1px);
  }
  .loading-card {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    width: 300px;
    text-align: center;
  }
  .loading-spinner {
    border: 3px solid #f3f3f3;
    border-radius: 50%;
    border-top: 3px solid #2c3e50;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 15px auto;
  }
  .loading-spinner-button {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-left: 8px;
    vertical-align: middle;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .stations-list::-webkit-scrollbar {
    width: 8px;
  }
  .stations-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  .stations-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  .stations-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  .collapse-btn {
    width: 100%;
    padding: 8px;
    background: #f8f9fa;
    border: none;
    border-radius: 8px;
    margin-top: 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    color: #2c3e50;
  }
  .collapse-btn:hover {
    background: #e9ecef;
  }
  .collapse-btn::after {
    content: '‚ñº';
    font-size: 12px;
    transition: transform 0.3s ease;
  }
  .collapse-btn.collapsed::after {
    transform: rotate(-90deg);
  }
  .google-maps-btn {
      position: fixed;
      bottom: 28px;
      left: 50%;  
      transform: translateX(-50%);  
      background: white;
      padding: 10px 10px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      transition: all 0.3s ease;
  }
  .fuel-stations-btn {
      position: fixed;
      bottom: 28px;
      left: 50%;  
      transform: translateX(-50%);  
      background: white;
      padding: 10px 10px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      transition: all 0.3s ease;
  }
  .google-maps-btn:hover, .fuel-stations-btn:hover {
      background: #f8f9fa;
      transform: translate(-50%, -1px);  
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .station-marker-green {
      width: 25px;
      height: 41px;
      background: #00FF00;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  .station-marker-red {
      width: 25px;
      height: 41px;
      background: #FF0000;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  @media (max-width: 600px) {
    .route-inputs {
      width: 95%; 
      left: 2.5%; 
    }
  }
  .menu-icon {
    position: fixed;
    bottom: 28px; /* Changed from 10px to 28px */
    left: 10px;
    background: white;
    padding: 10px;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: pointer;
    z-index: 1000;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
  }
  .menu-icon:hover {
    background: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .sidebar {
    position: fixed;
    top: 0;
    left: -300px; 
    width: 300px; 
    height: 100vh;
    background: white; 
    color: black; 
    padding: 0;  
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    z-index: 1100;
    transition: left 0.3s ease;
  }
  .sidebar.open {
    left: 0; 
  }
  .map-type-options {
    background: white; 
    display: flex; 
    justify-content: space-around; 
    padding: 12px 0; 
    border-bottom: 1px solid #ddd; 
    margin-bottom: 0;  
    width: 100%;  
  }
  .map-type-option {
    display: flex;
    flex-direction: column; 
    align-items: center;
    justify-content: center; 
    cursor: pointer;
    padding: 5px 0; 
    position: relative;
  }
  .map-type-option span {
    margin: 0; 
    font-size: 12px; 
    font-weight: bold;
    margin-top: 4px; 
  }
  .map-type-option.selected svg, .map-type-option.selected span {
    color: #0087c7; 
  }
  .options-item {
    background: #f1f3f5; 
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    flex-direction: column; 
  }
  .options-title {
    color: #2c3e50; 
    font-weight: bold;
  }
  .options-subtitle {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    color: #0087c7; 
    margin-top: 4px; 
    font-size: 12px; 
  }
  .fullscreen-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .fullscreen-modal.open {
    display: flex;
  }
  .fullscreen-modal-full {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1200;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .fullscreen-modal-full.open {
    display: flex;
  }
  .modal-content-full {
    background: white;
    padding: 30px;
    border-radius: 12px;
    width: 98%;
    height: 98%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    text-align: center;
  }
  #stationsList table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
}

#stationsList th, #stationsList td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ccc;
}

#stationsList th {
    background-color: #f8f9fa;
    color: #2c3e50;
    font-weight: bold;
}

#stationsList td img {
    display: block;
    max-width: 40px;
    max-height: 40px;
    object-fit: cover;
    border-radius: 4px;
}

#stationsList button {
    background-color: #27ae60;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#stationsList button:hover {
    background-color: #219a52;
}
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    text-align: center;
  }
  .close-modal {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 10px;
    cursor: pointer;
    margin-top: 20px;
  }
  .brand-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: space-between;
  }
  .brand-options label {
    display: block;
    cursor: pointer;
    width: 48%;
    padding: 5px 0;
    border-bottom: 1px solid #e0e0e0;
  }
  .brand-filter-actions {
    display: flex;
    gap: 10px;
    margin: 0 0 20px 0;
    justify-content: center;
  }
  .brand-filter-btn {
    background: #f8f9fa;
    border: 2px solid #007BFF;
    color: #007BFF;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .brand-filter-btn:hover {
    background: #007BFF;
    color: white;
    transform: translateY(-1px);
  }
  .brand-filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    max-height: 60vh;
    overflow-y: auto;
    padding: 10px;
  }
  .brand-filter-item {
    padding: 15px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .brand-filter-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #007BFF;
  }
  .brand-filter-item.selected {
    border-color: #007BFF;
    background: rgba(0,123,255,0.05);
  }
  .brand-filter-icon {
    width: 30px;
    height: 30px;
    background: #f8f9fa;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .brand-filter-name {
    font-size: 14px;
    font-weight: 500;
    color: #2c3e50;
  }
  /* Add scrollbar styles for the brand filter grid */
  .brand-filter-grid::-webkit-scrollbar {
    width: 8px;
  }
  .brand-filter-grid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  .brand-filter-grid::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  .brand-filter-grid::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  .map-type-option.selected:after {
    content: '';
    display: block;
    width: 100%;
    height: 4px;
    background-color: #0087c7; 
    position: absolute;
    bottom: 0;
    left: 0;
  }
  /* Styles for app info at the bottom of the sidebar */
  .sidebar .app-info {
      position: absolute;
      bottom: 0;
      left: 0;  
      width: 100%;
      padding: 10px 0;
      background-color: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
  }
  .sidebar .app-info .app-logo {
      width: 32px;
      height: 32px;
      /*background-color: #2c3e50;*/
      border-radius: 50%;
      flex-shrink: 0;
  }
  .sidebar .app-info .app-details {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
  }
  .sidebar .app-info .app-name {
      font-size: 14px;
      font-weight: bold;
      color: #2c3e50;
      margin: 0;
  }
  .sidebar .app-info .app-version {
      font-size: 12px;
      color: #666;
      margin: 0;
  }
  .route-popup .leaflet-popup-content-wrapper {
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 0;
  }
  .route-popup .leaflet-popup-content {
    margin: 0;
    min-width: 120px; /* Reduced from 150px */
  }
  .route-popup .leaflet-popup-tip {
    background: white;
  }
  /* Updated styles for the shortest route popup */
  .route-popup-shortest .leaflet-popup-content-wrapper {
    background: #0087c7 !important;
  }
  .route-popup-shortest .leaflet-popup-tip {
    background: #0087c7 !important;
  }
  /* Updated styles for the location button */
  .current-location-btn {
    position: fixed;
    bottom: 28px; /* Changed from 10px to 28px */
    right: 60px;
    background: white;
    padding: 10px;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: pointer;
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  .current-location-btn:hover {
    background: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .options-wrapper {
      padding: 0 15px;
      margin-top: 15px; /* Add this line */
      overflow-y: auto;
  }
  .success-message {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #4CAF50;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .success-message.show {
    opacity: 1;
  }
  .onboarding-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .onboarding-content {
    max-width: 600px;
    width: 100%;
    text-align: center;
  }
  .onboarding-header {
    margin-bottom: 40px;
  }
  .onboarding-header h1 {
    font-size: 32px;
    color: #2c3e50;
    margin-bottom: 10px;
  }
  .onboarding-header p {
    color: #666;
    font-size: 16px;
  }
  .onboarding-step {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  .onboarding-step.active {
    display: block;
  }
  .onboarding-step h2 {
    font-size: 24px;
    color: #2c3e50;
    margin-bottom: 30px;
  }
  .fuel-type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
    max-height: 60vh;
    overflow-y: auto;
    padding: 10px;
  }
  .fuel-option {
    padding: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }
  .fuel-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .fuel-option.selected {
    border-color: #0087c7;
    background: rgba(0,123,255,0.05);
  }
  .fuel-icon {
    font-size: 24px;
    margin-bottom: 10px;
  }
  /* Add scrollbar styles for the fuel-type-grid */
  .fuel-type-grid::-webkit-scrollbar {
    width: 8px;
  }
  .fuel-type-grid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  .fuel-type-grid::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  .fuel-type-grid::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  .brand-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
    max-height: 60vh;
    overflow-y: auto;
    padding: 10px;
  }
  .brand-option {
    padding: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    background: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  .brand-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #007BFF;
  }
  .brand-option.selected {
    border-color: #0087c7;
    background: rgba(0,123,255,0.05);
  }
  .brand-icon {
    width: 40px;
    height: 40px;
    background: #f8f9fa;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }
  .brand-name {
    font-size: 14px;
    font-weight: 500;
    color: #2c3e50;
  }
  /* Add scrollbar styles for the brand grid */
  .brand-grid::-webkit-scrollbar {
    width: 8px;
  }
  .brand-grid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  .brand-grid::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  .brand-grid::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  .welcome-btn, .next-step-btn, .start-app-btn {
    background: #0087c7;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 200px;
    margin: 20px auto;
}

.welcome-btn:hover, .next-step-btn:hover, .start-app-btn:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.welcome-btn:disabled, .next-step-btn:disabled, .start-app-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.brand-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    justify-content: center;
}

.brand-action-btn {
    background: #f8f9fa;
    border: 2px solid #0087c7;
    color: #0087c7;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.brand-action-btn:hover {
    background: #007BFF;
    color: white;
    transform: translateY(-1px);
}

.info-button {
    background: none;
    border: none;
    padding: 4px;
    cursor: pointer;
    margin-left: 8px;
    vertical-align: middle;
    transition: transform 0.2s ease;
}

.info-button:hover {
    transform: scale(1.1);
}

.info-button svg {
    width: 16px;
    height: 16px;
}
.leaflet-bottom.leaflet-right {
    right: 0px; /* Move zoom controls to the right of the current location button */
    bottom: 0px; /* Align with other bottom buttons */
}

.leaflet-control-zoom.leaflet-bar.leaflet-control {
    margin: 0; /* Remove default margin */
  right: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Match other buttons' shadow */
}

.leaflet-control-zoom-in,
.leaflet-control-zoom-out {
    width: 34px !important; /* Match size with other buttons */
    height: 34px !important;
    line-height: 34px !important;
    background: white !important;
    color: #2c3e50 !important;
    font-size: 18px !important;
    font-weight: bold !important;
    border: none !important;
    transition: all 0.3s ease !important;
}

.leaflet-control-zoom-in:hover,
.leaflet-control-zoom-out:hover {
    background: #f8f9fa !important;
    color: #007BFF !important;
    transform: translateY(-1px);
}
 
.tutorial-container{
    display: flex;
    flex-direction: column;
}
.img-container{
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
}
.img-container6 {
    display: flex;
    flex-direction: column-reverse;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
}
.img-tutorial{
  width: 91px;
  height: 150px;
  margin-right: 10px;
  left: 20%;
}
.stations-list-btn {
  position: fixed;
  bottom: 28px;
  right: 10px; /* Position next to currentLocationBtn */
  background: #cccccc; /* Gray background to indicate disabled state */
  padding: 10px;
  border: none;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  cursor: not-allowed; /* Show disabled cursor */
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.8; /* Further indicate disabled state */
  transition: none; /* Remove hover effects */
}
/*------------------------------------Search sugestions---------------------------------------------*/
.search-suggestions {
    position: absolute;
    background: #f0f0f0;
    /*border: 1px solid #ccc;*/
    max-height: 150px;
    overflow-y: auto;
    width: 90%;
    z-index: 5000;
}

.suggestion-item {
    padding: 10px;
    cursor: pointer;
}

.suggestion-item:hover {
    background: #dbd9d9;
}
/*----------------------------------------------------------------------------------*/
</style>
</head>
<body>
<div id="onboardingScreen" class="onboarding-screen">
  <div class="onboarding-content">
    <!-- Welcome step -->
    <div class="onboarding-step active" id="welcome">
      <div class="app-logo">
        <img src="drivy-logo.png" style="margin-bottom: 25px; width: 80px;">
      </div>
      <div class="onboarding-header">
        <h1>Bienvenido a Drivy</h1>
        <p>La manera m√°s inteligente de encontrar las gasolineras con los mejores precios</p>
      </div>
      <button class="welcome-btn" onclick="showStep(1)">¬°Comencemos!</button>
    </div>
    
    <!-- Updated fuel type step -->
    <div class="onboarding-step" id="step1">
      <h2>¬øQu√© tipo de combustible utilizas?</h2>
      <div class="fuel-type-grid">
        <div class="fuel-option" data-value="Precio Gasolina 95 E5">
          <div class="fuel-icon">‚õΩ</div>
          <span>Gasolina 95 E5</span>
        </div>
        <div class="fuel-option" data-value="Precio Gasolina 95 E5 Premium">
          <div class="fuel-icon">‚õΩ</div>
          <span>Gasolina 95 E5 Premium</span>
        </div>
        <div class="fuel-option" data-value="Precio Gasolina 98 E5">
          <div class="fuel-icon">‚õΩ</div>
          <span>Gasolina 98 E5</span>
        </div>
        <div class="fuel-option" data-value="Precio Gasoleo A">
          <div class="fuel-icon">üõ¢Ô∏è</div>
          <span>Diesel A</span>
        </div>
        <div class="fuel-option" data-value="Precio Gasoleo Premium">
          <div class="fuel-icon">üõ¢Ô∏è</div>
          <span>Diesel Premium</span>
        </div>
        <div class="fuel-option" data-value="Precio Hidrogeno">
          <div class="fuel-icon">üíß</div>
          <span>Hidr√≥geno</span>
        </div>
        <div class="fuel-option" data-value="Precio Gas Natural Comprimido">
          <div class="fuel-icon">üîã</div>
          <span>GNC</span>
        </div>
        <div class="fuel-option" data-value="Precio Gas Natural Licuado">
          <div class="fuel-icon">üîã</div>
          <span>GNL</span>
        </div>
        <div class="fuel-option" data-value="Precio Gases licuados del petr√≥leo">
          <div class="fuel-icon">üí®</div>
          <span>GLP</span>
        </div>
        <div class="fuel-option" data-value="Precio Bioetanol">
          <div class="fuel-icon">üå±</div>
          <span>Bioetanol</span>
        </div>
        <div class="fuel-option" data-value="Precio Biodiesel">
          <div class="fuel-icon">üå±</div>
          <span>Biodiesel</span>
        </div>
      </div>
      <button class="next-step-btn" onclick="showStep(2)" disabled>Siguiente</button>
    </div>
    
    <div class="onboarding-step" id="step2">
      <h2>Selecciona tus marcas preferidas</h2>
      <div class="brand-actions">
        <button class="brand-action-btn" onclick="selectAllBrandsOnboarding()">Seleccionar Todas</button>
        <button class="brand-action-btn" onclick="deselectAllBrandsOnboarding()">Deseleccionar Todas</button>
      </div>
      <div class="brand-grid" id="onboardingBrands">
        <!-- Brands will be populated via JavaScript -->
      </div>
      <button class="start-app-btn" onclick="showStep(3)" disabled>Siguiente</button>
    </div>
    <div class="onboarding-step" id="step3">
      <h2>¬øC√≥mo se muestran las gasolineras?</h2>
      <div class="tutorial-container">
        <div class="img-container">
          <img src="Std_fuel_station.PNG" alt="std" class="img-tutorial">
          <p>Las gasolineras aparecer√°n con el borde negro</p>
        </div>
        <div class="img-container">
          <img src="Recommended_fuel_station.PNG" alt="recommended" class="img-tutorial">
          <p>Las gasolineras recomendadas en cada tramo aparecer√°n con el borde azul</p>
        </div>
        <div class="img-container">
          <img src="Cheapest_fuel_station.PNG" alt="cheapest" class="img-tutorial">
          <p>La gasolinera m√°s barata aparecer√° con el borde verde.</p>
        </div>
      </div>
      <button class="next-step-btn" onclick="showStep(4)">Siguiente</button>
    </div>
    <div class="onboarding-step" id="step4">
      <h2>Selecciona tus gasolineras favoritas y a√±√°delas a la ruta</h2>
      <div class="tutorial-container">
        <div class="img-container">
          <img src="select_route.PNG" alt="route" class="img-tutorial4" style="width:200px;">
          <p>Selecciona tu ruta preferida</p>
        </div>
        <div class="img-container">
          <img src="station_info.PNG" alt="station" class="img-tutorial4" style="width:200px;">
          <p>A√±ade la estaci√≥n deseada a la ruta</p>
        </div>
        <div class="img-container">
          <img src="open_google.PNG" alt="open_google" class="img-tutorial4" style="width:200px;">
          <p>Abre la ruta completa en Google Maps</p>
        </div>
      </div>
      <button class="next-step-btn" onclick="showStep(5)">Siguiente</button>
    </div>
    <div class="onboarding-step" id="step5">
      <h2>Gasolineras en tu zona</h2>
      <div class="tutorial-container">
        <div class="img-container">
          <img src="place_stations.PNG" alt="stations" class="img-tutorial5" style="width:180px;">
          <p>Adem√°s, podr√°s descubrir qu√© gasolineras hay en tu zona</p>
        </div>
      </div>
      <button class="next-step-btn" onclick="showStep(6)">¬°Ya casi est√°!</button>
    </div>
    <div class="onboarding-step" id="step6">
      <h2>Configura la barra de navegaci√≥n</h2>
      <div class="tutorial-container">
        <div class="img-container6">
          <img src="sidebar.PNG" alt="sidebar" class="img-tutorial6" style="height:320px;">
          <p style="margin-bottom: 10px">Podr√°s modificar todos los par√°metros en la barra lateral de navegaci√≥n</p>
        </div>
      </div>
      <button class="next-step-btn" onclick="completeOnboarding()">¬°Empieza a usar Drivy!</button>
    </div>
  </div>
</div>
<div class="route-inputs">
  <input type="search" id="origin" placeholder="Origen" <!--oninput="getSuggestions(this.value, 'origin')"/>
  <div class="search-suggestions"></div>
  <input type="search" id="destination" placeholder="Destino" <!--oninput="getSuggestions(this.value, 'destination')"/>
  <div class="search-suggestions"></div>
  <button id="calculateRouteBtn" onclick="calculateRoute()">
    <span>Calcula la Ruta</span>
    <span id="routeSpinner" class="loading-spinner-button" style="display: none;"></span>
  </button>
  <button id="clearStationsBtn" style="display: none;" onclick="clearStations()">Borrar gasolineras</button>
</div>
<div id="loadingCard" class="loading-card" style="display: none;">
  <div class="loading-spinner"></div>
  <div style="text-align: center;">Cargando gasolineras...</div>
</div>
<div id="map"></div>
<button id="googleMapsBtn" class="google-maps-btn" onclick="exportToGoogleMaps()" style="display: none;">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="#0087c7">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
    Abrir en Google Maps
</button>
<button id="showFuelStations" class="fuel-stations-btn" style="display: block;">Mostrar gasolineras en esta zona</button>
<button id="menuIcon" class="menu-icon" onclick="toggleSidebar()">
    <svg width="24" height="24" viewBox="0 0 24 24">
        <path d="M3 6h18v2H3V6zm0 6h18v2H3v-2zm0 6h18v2H3v-2z"/>
    </svg>
</button>
<button id="currentLocationBtn" class="current-location-btn" onclick="useCurrentLocation()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="#0087c7">
        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
    </svg>
</button>
<button id="stationsListBtn" class="stations-list-btn" disabled>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="#666666">
        <path d="M22.6 16.4V20L1 20 1 16.4 22.6 16.4ZM22.6 9.2V12.8L1 12.8 1 9.2 22.6 9.2ZM22.6 2V5.6L1 5.6 1 2 22.6 2Z"/>
    </svg>
</button>
<div id="sidebar" class="sidebar">
    <div class="map-type-options">
      <div class="map-type-option standard-option" onclick="setMapType('standard')">
        <svg width="24" height="24" viewBox="0 0 24 24" class="map-type-svg">
          <rect x="4" y="4" width="16" height="16" stroke="#2c3e50" fill="transparent"/>
          <line x1="4" y1="8" x2="20" y2="8" stroke="#2c3e50" />
          <line x1="4" y1="16" x2="20" y2="16" stroke="#2c3e50" />
        </svg>
        <span>Est√°ndar</span>
      </div>
      <div class="map-type-option hybrid-option" onclick="setMapType('hybrid')">
        <svg width="24" height="24" viewBox="0 0 24 24" class="map-type-svg">
          <path d="M4 4h16v16H4z" fill="none" stroke="#2c3e50"/>
          <line x1="4" y1="12" x2="20" y2="12" stroke="#2c3e50" />
          <line x1="12" y1="4" x2="12" y2="20" stroke="#2c3e50" />
        </svg>
        <span>H√≠brido</span>
      </div>
      <div class="map-type-option satellite-option" onclick="setMapType('satellite')">
        <svg width="24" height="24" viewBox="0 0 24 24" class="map-type-svg">
          <circle cx="12" cy="12" r="10" stroke="#2c3e50" fill="transparent"/>
          <path d="M4 12a8 8 0 0 1 16 0" stroke="#2c3e50" />
        </svg>
        <span>Sat√©lite</span>
      </div>
    </div>
    <div class="options-wrapper">
        <ul class="options-list">
            <li class="options-item" onclick="toggleFullscreenModal('modalFuelType')">
                <span class="options-title">Tipo de Combustible</span>
                <span class="options-subtitle">Elige el tipo de combustible</span>
            </li>
            <li class="options-item" onclick="toggleFullscreenModal('modalBrandFilter')">
                <span class="options-title">Filtro de Gasolineras</span>
                <span class="options-subtitle">Selecciona tus marcas favoritass</span>
            </li>
            <li class="options-item" onclick="toggleFullscreenModal('modalTankCapacity')">
                <span class="options-title">Capacidad del dep√≥sito</span>
                <span class="options-subtitle">Introduce el tama√±o del dep√≥sito</span>
            </li>
            <li class="options-item" onclick="toggleFullscreenModal('modalFuelConsumption')">
                <span class="options-title">Consumo de combustible</span>
                <span class="options-subtitle">Introduce el consumo medio de tu veh√≠culo</span>
            </li>
            <li class="options-item" onclick="toggleFullscreenModal('modalStationsNumber')">
                <span class="options-title">N√∫mero de gasolineras</span>
                <span class="options-subtitle">Introduce el n¬∫ de gasolineras para ver en tu zona</span>
            </li>
            <li class="options-item" onclick="restartTutorial()">
                <span class="options-title">Tutorial</span>
                <span class="options-subtitle">Explora de nuevo las funciones principales de Drivy</span>
            </li>
            <li class="options-item" onclick="toggleFullscreenModal('modalDeleteAds')">
                <span class="options-title">Pol√≠tica de Privacidad</span>
                <!-- No subtitle for Privacy Policy section -->
            </li>
            <li class="options-item" onclick="toggleFullscreenModal('modalContact')">
                <span class="options-title">Contacto</span>
                <!-- No subtitle for Contact section -->
            </li>
        </ul>
    </div>
    <div class="app-info">
        <div class="app-logo">
          <img src="drivy-logo.png" style="height: 100%;">
        </div>
        <div class="app-details">
            <div class="app-name">Drivy</div>
            <div class="app-version">Version 1.3.1</div>
        </div>
    </div>
</div>

<!-- Modals for each section -->
<div id="modalBrandFilter" class="fullscreen-modal">
  <div class="modal-content">
    <h2 style="margin-bottom: 20px;">Selecciona tus gasolineras favoritas</h2>
    <div class="brand-filter-actions">
      <button class="brand-filter-btn" onclick="selectAllBrands()">Seleccionar Todas</button>
      <button class="brand-filter-btn" onclick="deselectAllBrands()">Deseleccionar Todas</button>
    </div>
    <div id="brandFilterGrid" class="brand-filter-grid">
      <!-- Brand items will be populated via JavaScript -->
    </div>
    <button class="close-modal" onclick="applyBrandFilter()">Aplicar</button>
  </div>
</div>

<div id="modalTankCapacity" class="fullscreen-modal">
  <div class="modal-content">
    <h2>capacidad del dep√≥sito</h2>
    <p>Introduce la capacidad de tu dep√≥sito (en Litros):</p>
    <input type="number" id="tankCapacityInput" placeholder="p.ej., 50" min="0" step="1" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd;"/>
    <button class="close-modal" onclick="applyTankCapacity()">Aplicar</button>
    <button class="close-modal" onclick="toggleFullscreenModal('modalTankCapacity')">Cerrar</button>
  </div>
</div>

<div id="modalFuelConsumption" class="fullscreen-modal">
  <div class="modal-content">
    <h2>Consumo medio</h2>
    <p>Introduce el consume medio de tu veh√≠culo (L/100km):</p>
    <input type="number" id="fuelConsumptionInput" placeholder="p.ej., 6.5" min="0" step="0.1" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd;"/>
    <button class="close-modal" onclick="applyFuelConsumption()">Aplicar</button>
    <button class="close-modal" onclick="toggleFullscreenModal('modalFuelConsumption')">Cerrar</button>
  </div>
</div>
  
<div id="modalStationsNumber" class="fullscreen-modal">
  <div class="modal-content">
    <h2>N√∫mero de gasolineras</h2>
    <p>Introduce el n¬∫ de gasolineras para ver en tu zona:</p>
    <input type="number" id="stationsNumberInput" placeholder="p.ej., 10" min="0" step="1" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd;"/>
    <button class="close-modal" onclick="applyStationsNumber()">Aplicar</button>
    <button class="close-modal" onclick="toggleFullscreenModal('modalStationsNumber')">Cerrar</button>
  </div>
</div>

<div id="modalDeleteAds" class="fullscreen-modal">
  <div class="modal-content">
    <h2>Pol√≠tica de Privacidad</h2>
    <div class="policy-container" style="overflow-y: auto; height: 80%;">
    <section>
        <h3 style="text-align: left;">1. Identidad y Prop√≥sito</h3>
        <p style="color: #666; margin: 10px 0; text-align: left;"><strong>Drivy</strong> es una aplicaci√≥n creada sin √°nimo de lucro, concebida con el √∫nico objetivo de facilitar a los usuarios la toma de decisiones informadas sobre d√≥nde repostar, proporcionando informaci√≥n clara y accesible sobre precios y ubicaciones de gasolineras.</p>
        <p style="color: #666; margin-top: 0px; margin-bottom: 20px; text-align: left;"><strong>Drivy</strong> tiene como objetivo proporcionar informaci√≥n sobre gasolineras y precios de combustibles en Espa√±a, optimizando rutas y ayudando a los usuarios a encontrar las mejores opciones de suministro.</p>
        <h3 style="text-align: left;">2. Datos que Recopilamos</h3>
        <p style="color: #666; margin-top: 10px; margin-bottom: 5px; text-align: left;"><strong>Drivy</strong> recopila los siguientes datos de los usuarios:</p>
        <ul>
            <li style="color: #666; margin-top: 0px; margin-bottom: 5px; text-align: left;"><strong>- Ubicaci√≥n</strong>: Para mostrar estaciones de servicio cercanas y calcular rutas.
                <ul>
                    <li style="color: #666; margin-top: 0px; margin-bottom: 0px; text-align: left;"><em>*Nota</em>: La ubicaci√≥n es utilizada √∫nicamente para esta funcionalidad y no se almacena en nuestros servidores.</li>
                </ul>
            </li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 10px; text-align: left;"><strong>- Preferencias de combustible</strong>: Para personalizar las opciones mostradas.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 10px; text-align: left;"><strong>- Capacidad del dep√≥sito</strong>: Para personalizar las opciones mostradas.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 10px; text-align: left;"><strong>- Consumo medio del veh√≠culo</strong>: Para personalizar las opciones mostradas.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 10px; text-align: left;"><strong>- Marcas </strong>: Para personalizar las opciones mostradas.</li>
        </ul>
        <p style="color: #666; margin-top: 0px; margin-bottom: 20px; text-align: left;">Adicionalmente, obtenemos datos abiertos sobre gasolineras desde la fuente del <strong>Ministerio para la Transici√≥n Ecol√≥gica y el Reto Demogr√°fico</strong>.</p>

        <h3 style="text-align: left;">3. Finalidad del Uso de los Datos</h3>
        <p style="color: #666; margin-top: 10px; margin-bottom: 5px; text-align: left;">Los datos recopilados se emplean para:</p>
        <ol>
            <li style="color: #666; margin-top: 0px; margin-bottom: 5px; text-align: left;">- Mostrar gasolineras y sus precios de forma personalizada seg√∫n la ruta del usuario.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 5px; text-align: left;">- Proporcionar informaci√≥n relevante sobre combustibles y estaciones cercanas.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 20px; text-align: left;">- Mejorar la funcionalidad general de la aplicaci√≥n, siempre respetando los principios de minimizaci√≥n de datos y privacidad.</li>
        </ol>

        <h3 style="text-align: left;">4. Almacenamiento y Procesamiento de Datos</h3>
        <p style="color: #666; margin-top: 10px; margin-bottom: 5px; text-align: left;"><strong>Datos de los usuarios</strong>:</p>
        <ul>
            <li style="color: #666; margin-top: 0px; margin-bottom: 0px; text-align: left;">No almacenamos datos personales de los usuarios en nuestros servidores.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 10px; text-align: left;">La ubicaci√≥n del usuario es procesada localmente en el dispositivo y transmitida de manera segura para las funciones de la app.</li>
        </ul>
        <p style="color: #666; margin-top: 0px; margin-bottom: 5px; text-align: left;"><strong>Datos externos</strong>:</p>
        <ul>
            <li style="color: #666; margin-top: 0px; margin-bottom: 0px; text-align: left;">Los datos de gasolineras obtenidos desde el Ministerio se procesan en tiempo real para mostrarse en la aplicaci√≥n.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 20px; text-align: left;">No realizamos alteraciones en la informaci√≥n proporcionada por el Ministerio.</li>
        </ul>

        <h3 style="text-align: left;">5. Cumplimiento con las Licencias y Condiciones</h3>
        <p style="color: #666; margin-top: 10px; margin-bottom: 20px; text-align: left;"><strong>Drivy</strong> cumple con las condiciones de uso y licencias aplicables a los servicios y datos empleados en la aplicaci√≥n.</p>

        <h3 style="text-align: left;">6. Derechos del Usuario</h3>
        <p style="color: #666; margin-top: 10px; margin-bottom: 5px; text-align: left;">Los usuarios tienen derecho a:</p>
        <ul>
            <li style="color: #666; margin-top: 0px; margin-bottom: 5px; text-align: left;"><strong>- Acceder a los datos procesados</strong>: Consultar qu√© datos se est√°n procesando durante el uso de la aplicaci√≥n.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 5px; text-align: left;"><strong>- Eliminar datos</strong>: Aunque no almacenamos datos personales, cualquier configuraci√≥n o preferencia del usuario se puede restablecer.</li>
            <li style="color: #666; margin-top: 0px; margin-bottom: 20px; text-align: left;"><strong>- Revocar permisos</strong>: Los usuarios pueden desactivar el acceso a su ubicaci√≥n desde la configuraci√≥n de su dispositivo en cualquier momento.</li>
        </ul>
      
        <h3 style="text-align: left;">7. Privacidad de menores</h3>
        <p style="color: #666; margin-top: 10px; margin-bottom: 0px; text-align: left;">Nuestro Servicio no est√° dirigido a ninguna persona menor de 13 a√±os. No recopilamos deliberadamente informaci√≥n de identificaci√≥n personal de ninguna persona menor de 13 a√±os. Si usted es padre o tutor y sabe que su hijo nos ha proporcionado datos personales, p√≥ngase en contacto con nosotros. Si nos damos cuenta de que hemos recopilado datos personales de cualquier persona menor de 13 a√±os sin verificar el consentimiento de los padres, tomamos medidas para eliminar esa informaci√≥n de nuestros servidores.</p>
        <p style="color: #666; margin-top: 10px; margin-bottom: 20px; text-align: left;">Si necesitamos basarnos en el consentimiento como base legal para procesar su informaci√≥n y su pa√≠s requiere el consentimiento de un padre, es posible que solicitemos el consentimiento de sus padres antes de recopilar y utilizar esa informaci√≥n.</p>

        <h3 style="text-align: left;">8. Contacto</h3>
        <p style="color: #666; margin-top: 10px; margin-bottom: 10px; text-align: left;">Para consultas sobre esta Pol√≠tica de Privacidad o el uso de la aplicaci√≥n, por favor contacta a nuestro equipo:</p>
        <ul>
            <li style="color: #666; margin-top: 0px; margin-bottom: 10px; text-align: left;"><strong>Correo electr√≥nico</strong>: info.drivy@gmail.com</li>
        </ul>
      <ul>
            <li style="color: #666; margin-top: 0px; margin-bottom: 20px; text-align: left;"><strong>M√°s informaci√≥n</strong>: <a href="https://www.termsfeed.com/live/d9f10265-a480-48b4-9fc1-8f3d23f03192" target="_blank" style="color: #007BFF; text-decoration: none;">
            Privacy Policy
        </a>
        </li>
        </ul>

        <p style="color: #666; margin-top: 0px; margin-bottom: 0px; text-align: left;"><em>√öltima actualizaci√≥n: 24 de diciembre de 2024.</em></p>
    </section>
    </div>
    <button class="close-modal" onclick="toggleFullscreenModal('modalDeleteAds')">Cerrar</button>
  </div>
</div>

<div id="modalContact" class="fullscreen-modal">
  <div class="modal-content">
    <h2>Contacto</h2>
    <p style="color: #666; margin-top: 10px;">Para cualquier duda o sugerencia, no dude en contactar con nosotros en: info.drivy@gmail.com</p>
    <button class="close-modal" onclick="toggleFullscreenModal('modalContact')">Cerrar</button>
  </div>
</div>

<div id="modalFuelType" class="fullscreen-modal">
  <div class="modal-content">
    <h2>Selecciona el tipo de combustible</h2>
    <select id="fuelType" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd;">
      <option value="all">Todos los tipos</option>
      <option value="Precio Gasolina 95 E5">Gasolina 95 E5</option>
      <option value="Precio Gasolina 95 E5 Premium">Gasolina 95 E5 Premium</option>
      <option value="Precio Gasolina 98 E5">Gasolina 98 E5</option>
      <option value="Precio Gasoleo A">Diesel A</option>
      <option value="Precio Gasoleo Premium">Diesel Premium</option>
      <option value="Precio Hidrogeno">Hidr√≥geno</option>
      <option value="Precio Gas Natural Comprimido">GNC</option>
      <option value="Precio Gas Natural Licuado">GNL</option>
      <option value="Precio Gases licuados del petr√≥leo">GLP</option>
      <option value="Precio Bioetanol">Bioetanol</option>
      <option value="Precio Biodiesel">Biodiesel</option>
    </select>
    <button class="close-modal" onclick="applyFuelType()">Aplicar</button>
    <button class="close-modal" onclick="toggleFullscreenModal('modalFuelType')">Cerrar</button>
  </div>
</div>
<div id="stationsModal" class="fullscreen-modal-full">
    <div class="modal-content-full">
        <h2 style="margin-top: 0px; margin-bottom: 5px;">Gasolineras en ruta</h2>
        <div id="stationsList" style="height: 90%; overflow-y: auto;">
            <!-- Aqu√≠ aparecer√°n las gasolineras -->
        </div>
        <button class="close-modal" onclick="closeModal('stationsModal')">Cerrar</button>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
//Load the preferred Fuel Type
document.addEventListener('DOMContentLoaded', () => {
    const storedFuelType = localStorage.getItem('preferredFuelType');
    if (storedFuelType) {
        const fuelTypeSelect = document.getElementById('fuelType');
        if (fuelTypeSelect) {
            fuelTypeSelect.value = storedFuelType;
            console.log('Tipo de combustible inicializado:', storedFuelType);
        }
    }
});

let userMarker = null; // Variable para almacenar el marcador del usuario
let firstTime = true;  // Bandera para centrar el mapa solo la primera vez

function trackUserLocation() {
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
            (position) => {
                const { latitude, longitude } = position.coords;

                // Si el marcador no existe, crear un c√≠rculo azul
                if (!userMarker) {
                    userMarker = L.circleMarker([latitude, longitude], {
                        radius: 10, // Tama√±o del c√≠rculo
                        color: '#007BFF', // Color del borde
                        fillColor: '#007BFF', // Color de relleno
                        fillOpacity: 0.5, // Transparencia
                    }).addTo(map).bindPopup("Tu ubicaci√≥n actual");
                } else {
                    // Actualizar la posici√≥n del marcador
                    userMarker.setLatLng([latitude, longitude]);
                }

                // Centrar el mapa solo la primera vez
                if (firstTime) {
                    map.setView([latitude, longitude], 15);
                    firstTime = false; // Cambiar bandera para evitar centrado continuo
                }
            },
            (error) => {
                console.error("Error obteniendo la ubicaci√≥n: ", error.message);
            },
            {
                enableHighAccuracy: true, // Para mayor precisi√≥n
                maximumAge: 0, // Siempre obtener la posici√≥n m√°s reciente
                timeout: 5000 // Tiempo m√°ximo para obtener la ubicaci√≥n
            }
        );
    } else {
        alert("La geolocalizaci√≥n no est√° soportada en tu navegador.");
    }
}


// Llamar a la funci√≥n cuando el mapa est√© listo
document.addEventListener("DOMContentLoaded", () => {
    trackUserLocation();
});  
  
document.addEventListener('DOMContentLoaded', () => {
    const storedTankCapacity = localStorage.getItem('tankCapacity');
    if (storedTankCapacity) {
        const tankCapacityInput = document.getElementById('tankCapacityInput');
        const tankCapacitySubtitle = document.querySelector('.options-item:nth-child(3) .options-subtitle');
        
        if (tankCapacityInput) {
            tankCapacityInput.value = storedTankCapacity; // Prellenar el input del modal
        }

        if (tankCapacitySubtitle) {
            tankCapacitySubtitle.textContent = `${storedTankCapacity}L`; // Actualizar el subt√≠tulo
        }

        console.log('Capacidad del tanque inicializada:', storedTankCapacity);
    }
});
  
document.addEventListener('DOMContentLoaded', () => {
    const storedFuelConsumption = localStorage.getItem('fuelConsumption');
    if (storedFuelConsumption) {
        const fuelConsumptionInput = document.getElementById('fuelConsumptionInput');
        const fuelConsumptionSubtitle = document.querySelector('.options-item:nth-child(4) .options-subtitle');
        
        if (fuelConsumptionInput) {
            fuelConsumptionInput.value = storedFuelConsumption; // Prellenar el input del modal
        }

        if (fuelConsumptionSubtitle) {
            fuelConsumptionSubtitle.textContent = `${storedFuelConsumption}L`; // Actualizar el subt√≠tulo
        }

        console.log('Capacidad del tanque inicializada:', storedFuelConsumption);
    }
});

// Initialize global variables
let map;
let markers = [];  // Initialize empty markers array
let routePolylines = [];
let availableRoutes = [];
let selectedRouteIndex = null;

const tileLayers = {
    'standard': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }),
    'hybrid': L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '¬© Google Maps'
    }),
    'satellite': L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '¬© Google Maps'
    })
};

// Initialize the map
map = L.map('map', {
    center: [40.416775, -3.703790], // Center of Spain
    zoom: 6,
    layers: [tileLayers.standard], // Set default layer
    zoomControl: false // Disable default zoom control
});

// Add zoom control to bottom right
//L.control.zoom({
    //position: 'bottomright'
//}).addTo(map);

//------------------------------------------------------------------------------------
function getSuggestions(query, targetInputId) {
    const controller = new AbortController();
    const signal = controller.signal;

    // Abortar solicitudes previas
    if (window.currentSearchController) {
        window.currentSearchController.abort();
    }
    window.currentSearchController = controller;

const startTime = performance.now(); // Marca el inicio
  
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`, {
        signal,
        headers: {
            'Accept': 'application/json',
            'User-Agent': 'Drivy/1.2.2',
        },
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
          const endTime = performance.now(); // Marca el fin
        console.log('API response time:', endTime - startTime, 'ms');
            const suggestionsContainer = document.querySelector(`#${targetInputId}`).nextElementSibling;
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.style.display = 'block'; // Mostrar sugerencias

            if (data.length > 0) {
                const fragment = document.createDocumentFragment();

                data.forEach(place => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';

                    const mainName = place.display_name.split(',')[0];
                    const restOfAddress = place.display_name.split(',').slice(1).join(',');

                    div.innerHTML = `
                        <strong>${mainName}</strong>
                        <small style="color: var(--text-color); opacity: 0.7;">${restOfAddress.trim()}</small>
                    `;

                    // Evento de clic en la sugerencia
                    div.addEventListener('click', () => {
                        const input = document.querySelector(`#${targetInputId}`);
                        input.value = place.display_name;
                        suggestionsContainer.classList.remove('active');

                        // Almacenar coordenadas para c√°lculos de ruta
                        //if (targetInputId === 'origin') {
                            //routePoints.start = [place.lat, place.lon];
                        //} else if (targetInputId === 'destination'){
                            //routePoints.end = [place.lat, place.lon];
                        //}

                        // Ocultar el contenedor de sugerencias
                        suggestionsContainer.style.display = 'none';
                        //suggestionsContainer.innerHTML = ''; // Limpiar sugerencias
                    });

                    fragment.appendChild(div);
                });

                suggestionsContainer.appendChild(fragment);
                suggestionsContainer.classList.add('active');
            } else {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = 'No results found';
                suggestionsContainer.appendChild(div);
                suggestionsContainer.classList.add('active');
            }
        })
        .catch(error => {
            if (error.name === 'AbortError') return;

            const suggestionsContainer = document.querySelector(`#${targetInputId}`).nextElementSibling;
            suggestionsContainer.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = 'Error fetching suggestions. Please try again.';
            suggestionsContainer.appendChild(div);
            suggestionsContainer.classList.add('active');

            console.error('Error getting suggestions:', error);
        });
  document.querySelectorAll('.route-inputs input[type="search"]').forEach(input => {
    input.addEventListener('blur', () => {
        const suggestionsContainer = input.nextElementSibling;
        setTimeout(() => {
            suggestionsContainer.style.display = 'none';
        }, 200); // Un peque√±o retraso para permitir el clic en las sugerencias
    });
});
  document.querySelectorAll('.route-inputs input[type="text"]').forEach(input => {
    input.addEventListener('focus', () => {
        const suggestionsContainer = input.nextElementSibling;
        if (suggestionsContainer.innerHTML.trim() !== '') {
            suggestionsContainer.style.display = 'block';
        }
    });
});
}

//------------------------------------------------------------------------------------

//Limitar a 2 decimales
document.getElementById("fuelConsumptionInput").addEventListener("blur", function (event) {
      const input = event.target;
      const value = parseFloat(input.value);

      if (!isNaN(value)) {
          // Limitar a 2 decimales
          input.value = value.toFixed(2);
      }
  });
  
document.getElementById("tankCapacityInput").addEventListener("blur", function (event) {
      const input = event.target;
      const value = parseFloat(input.value);

      if (!isNaN(value)) {
          // Limitar a 2 decimales
          input.value = value.toFixed(0);
      }
  });

document.getElementById("stationsNumberInput").addEventListener("blur", function (event) {
      const input = event.target;
      const value = parseFloat(input.value);

      if (!isNaN(value)) {
          // Limitar a 2 decimales
          input.value = value.toFixed(0);
      }
  });
  
  
async function geocodeAddress(address) {
    try {
        const encodedAddress = encodeURIComponent(address);
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1`);
        const data = await response.json();
        
        if (!data || data.length === 0) {
            throw new Error('Address not found');
        }
        
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    } catch (error) {
        throw new Error('Error geocoding address: ' + error.message);
    }
}

function isPointNearRoutePart(point, routeCoords, threshold = 0.01) {
    for (let i = 0; i < routeCoords.length - 1; i++) {
        const start = routeCoords[i];
        const end = routeCoords[i + 1];
        
        const distance = pointToLineDistance(point, start, end);
        if (distance < threshold) {
            return true;
        }
    }
    return false;
}

function pointToLineDistance(point, lineStart, lineEnd) {
    const lat = point[0];
    const lng = point[1];
    const lat1 = lineStart.lat || lineStart[0];
    const lng1 = lineStart.lng || lineStart[1];
    const lat2 = lineEnd.lat || lineEnd[0];
    const lng2 = lineEnd.lng || lineEnd[1];
    
    const A = lat - lat1;
    const B = lng - lng1;
    const C = lat2 - lat1;
    const D = lng2 - lng1;
    
    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;
    
    if (lenSq !== 0) {
        param = dot / lenSq;
    }
    
    let xx, yy;
    
    if (param < 0) {
        xx = lat1;
        yy = lng1;
    } else if (param > 1) {
        xx = lat2;
        yy = lng2;
    } else {
        xx = lat1 + param * C;
        yy = lng1 + param * D;
    }
    
    const dx = lat - xx;
    const dy = lng - yy;
    
    return Math.sqrt(dx * dx + dy * dy);
}

function getSections(coords, totalDistance) {
    const sections = [];
    const sectionLength = Math.min(50, totalDistance / 3); // Split into sections of 50km or smaller
    let currentSection = {
        coords: [coords[0]]
    };
    let currentDistance = 0;
    
    for (let i = 1; i < coords.length; i++) {
        const prevCoord = coords[i - 1];
        const currentCoord = coords[i];
        const segmentDistance = getDistance(
            prevCoord.lat || prevCoord[0],
            prevCoord.lng || prevCoord[1],
            currentCoord.lat || currentCoord[0],
            currentCoord.lng || currentCoord[1]
        );
        
        currentDistance += segmentDistance;
        currentSection.coords.push(currentCoord);
        
        if (currentDistance >= sectionLength) {
            sections.push(currentSection);
            currentSection = {
                coords: [currentCoord]
            };
            currentDistance = 0;
        }
    }
    
    if (currentSection.coords.length > 1) {
        sections.push(currentSection);
    }
    
    return sections;
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

function initializeBrandFilter() {
    const brandData = [
        { name: 'Alcampo', image: 'ALCAMPO.png' },
        { name: 'AutonetOil', image: 'AUTONETOIL.png' },
        { name: 'Avia', image: 'AVIA.png' },
        { name: 'Ballenoil', image: 'BALLENOIL.png' },
        { name: 'BDMED', image: 'BDMED.png' },
        { name: 'Bonarea', image: 'BONAERA.png' },
        { name: 'Bp', image: 'BP.png' },
        { name: 'Campsa', image: 'CAMPSA.png' },
        { name: 'Carrefour', image: 'CARREFOUR.png' },
        { name: 'Cepsa', image: 'CEPSA.png' },
        { name: 'Disa', image: 'DISA.png' },
        { name: 'E.leclerc', image: 'E.LECLERC.png' },
        { name: 'EasyGas', image: 'EASYGAS.png' },
        { name: 'ENI', image: 'ENI.png' },
        { name: 'Eroski', image: 'EROSKI.png' },
        { name: 'Esso', image: 'ESSO.png' },
        { name: 'EuskadiLowCost', image: 'EUSKADILOWCOST.png' },
        { name: 'Galp', image: 'GALP.png' },
        { name: 'GasExpress', image: 'GASEXPRESS.png' },
        { name: 'Lavaplus', image: 'LAVAPLUS.png' },
        { name: 'Makro', image: 'MAKRO.png' },
        { name: 'Meroil', image: 'MEROIL.png' },
        { name: 'Nafte', image: 'NAFTE.png' },
        { name: 'Pcan', image: 'PCAN.png' },
        { name: 'Petrocat', image: 'PETROCAT.png' },
        { name: 'Petronor', image: 'PETRONOR.png' },
        { name: 'Petroprix', image: 'PETROPRIX.png' },
        { name: 'Plenoil', image: 'PLENOIL.png' },
        { name: 'Q8', image: 'Q8.png' },
        { name: 'Repsol', image: 'REPSOL.png' },
        { name: 'Shell', image: 'SHELL.png' },
        { name: 'Supeco', image: 'SUPECO.png' },
        { name: 'Texaco', image: 'TEXACO.png' },
        { name: 'Tgas', image: 'TGAS.png' },
        { name: 'Otras', image: 'STD.png' }
    ];
  
    // Obtener las marcas almacenadas en localStorage
    const storedBrands = JSON.parse(localStorage.getItem('preferredBrands')) || [];
    
    if (!document.getElementById('brandFilterOptions')) {
        const container = document.createElement('div');
        container.id = 'brandFilterOptions';
        container.className = 'brand-filter-grid';
        document.querySelector('#modalBrandFilter .modal-content').insertBefore(
            container,
            document.querySelector('#modalBrandFilter .close-modal')
        );
    }
    
    const container = document.getElementById('brandFilterOptions');
    container.innerHTML = ''; // Clear existing content
    
    brandData.forEach(brand => {
        const isSelected = storedBrands.includes(brand.name); // Verifica si la marca est√° seleccionada
        const div = document.createElement('div');
        div.className = `brand-filter-item ${isSelected ? 'selected' : ''}`; // A√±ade la clase 'selected' si aplica
        div.setAttribute('data-name', brand.name);
        div.innerHTML = `
            <div class="brand-filter-icon">
                <img src="${brand.image}" alt="${brand.name}" style="width: 25px; height 25px; object-fit: contain;">
            </div>
            <label class="brand-filter-name">
                <input type="checkbox" value="${brand.name}" ${isSelected ? 'checked' : ''} style="display: none;">
                ${brand.name}
            </label>
        `;
        
        div.addEventListener('click', () => {
            const checkbox = div.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            div.classList.toggle('selected', checkbox.checked);
            updateBrandSubtitle();
        });
        
        container.appendChild(div);
    });

    // Add event listeners for the Select All and Deselect All buttons
    document.querySelector('#modalBrandFilter .brand-filter-actions').innerHTML = `
        <button class="brand-filter-btn" onclick="selectAllBrands()">Seleccionar Todas</button>
        <button class="brand-filter-btn" onclick="deselectAllBrands()">Deseleccionar Todas</button>
    `;
}

function selectAllBrands() {
    const items = document.querySelectorAll('#brandFilterOptions .brand-filter-item');
    items.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.checked = true;
        item.classList.add('selected');
    });
    updateBrandSubtitle();
}

function deselectAllBrands() {
    const items = document.querySelectorAll('#brandFilterOptions .brand-filter-item');
    items.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        checkbox.checked = false;
        item.classList.remove('selected');
    });
    updateBrandSubtitle();
}
  
document.addEventListener('DOMContentLoaded', () => {
    
    // Cargar marcas seleccionadas desde localStorage
    const storedBrands = JSON.parse(localStorage.getItem('preferredBrands')) || [];
    console.log('Stored brands:', storedBrands);
    
    const modalBrandFilter = document.getElementById('modalBrandFilter');
    if (modalBrandFilter) {
        const brandFilterOption = modalBrandFilter.querySelector('.modal-content #brandFilterOptions');
        if (brandFilterOption) {
            const brandOptions = brandFilterOption.querySelectorAll('.brand-filter-item');
            console.log('Found brand options:', brandOptions);
            
            // Eliminar la clase 'selected' de todos los elementos
            brandOptions.forEach(option => {
                option.classList.remove('selected');
            });
            
            // A√±adir la clase 'selected' a los elementos que coincidan con las marcas almacenadas
            brandOptions.forEach(option => {
                const brandName = option.dataset.name;
                console.log('Brand name:', brandName);
                
                if (storedBrands.includes(brandName)) {
                    option.classList.add('selected');
                    console.log('Brand selected:', brandName);
                } else {
                    console.log('Brand not found in storedBrands:', brandName);
                }
            });
        } else {
            console.log('brandFilterOptions element not found');
        }
    } else {
        console.log('modalBrandFilter element not found');
    }
});

function createStationMarker(lat, lng, isLowest, isOverallLowest, stationName = '') {
  let markerIcon;
  
  // Standard dimensions for all markers
  const markerSize = [30, 40];
  const markerAnchor = [15, 40];
  const popupAnchor = [0, -40];
  
  // Get the base marker image based on marker type
  let baseMarkerImage;
  if (isOverallLowest) {
    baseMarkerImage = 'cheapest-marker.png';
  } else if (isLowest) {
    baseMarkerImage = 'recommended-marker.png';
  } else {
    baseMarkerImage = 'standard-marker.png';
  }

  const stationNameLower = stationName.toLowerCase();
  let brandImage = 'STD.png'; // Default image if no match found
  
  // Brand matching object
  const brandMatches = {
    'alcampo': 'ALCAMPO.png',
    'autonetoil': 'AUTONETOIL.png',
    'avia': 'AVIA.png',
    'ballenoil': 'BALLENOIL.png',
    'bdmed': 'BDMED.png',
    'bp': 'BP.png',
    'campsa': 'CAMPSA.png',
    'carrefour': 'CARREFOUR.png',
    'cepsa': 'CEPSA.png',
    'disa': 'DISA.png',
    'e.leclerc': 'E.LECLERC.png',
    'easygas': 'EASYGAS.png',
    'eni': 'ENI.png',
    'eroski': 'EROSKI.png',
    'esso': 'ESSO.png',
    'euskadilowcost': 'EUSKADILOWCOST.png',
    'galp': 'GALP.png',
    'gasexpress': 'GASEXPRESS.png',
    'lavaplus': 'LAVAPLUS.png',
    'makro': 'MAKRO.png',
    'meroil': 'MEROIL.png',
    'nafte': 'NAFTE.png',
    'pcan': 'PCAN.png',
    'petrocat': 'PETROCAT.png',
    'petronor': 'PETRONOR.png',
    'petroprix': 'PETROPRIX.png',
    'plenoil': 'PLENOIL.png',
    'q8': 'Q8.png',
    'repsol': 'REPSOL.png',
    'shell': 'SHELL.png',
    'supeco': 'SUPECO.png',
    'texaco': 'TEXACO.png',
    'tgas': 'TGAS.png',
    'bonarea': 'BONAERA.png'
  };

  // Find matching brand
  for (const [brandKey, brandImageFile] of Object.entries(brandMatches)) {
    if (stationNameLower.includes(brandKey)) {
      brandImage = brandImageFile;
      break;
    }
  }

  // Create custom HTML for marker with brand logo
  const customIconHtml = `
    <div style="position: relative; width: ${markerSize[0]}px; height: ${markerSize[1]}px;">
      <img src="${baseMarkerImage}" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;" />
      <img src="${brandImage}" style="width: 25px; height: 25px; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%;" />
    </div>`;

  markerIcon = L.divIcon({
    html: customIconHtml,
    className: 'custom-marker',
    iconSize: markerSize,
    iconAnchor: markerAnchor,
    popupAnchor: popupAnchor
  });

  return L.marker([lat, lng], {icon: markerIcon});
}

async function loadFuelStationsInSections(sections, totalDistance) {
    try {
        const response = await fetch('https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/');
        const data = await response.json();
        const selectedFuelType = document.getElementById('fuelType').value;
        const recognizedBrands = ["alcampo", "autonetoil", "avia", "ballenoil", "bdmed", "bp", "campsa",
    "carrefour", "cepsa", "disa", "e.leclerc", "easygas", "eni", "eroski",
    "esso", "euskadilowcost", "galp", "gasexpress", "lavaplus", "makro",
    "meroil", "nafte", "pcan", "petrocat", "petronor", "petroprix", "plenoil",
    "q8", "repsol", "shell", "supeco", "texaco", "tgas", "bonarea"]; // Lista de marcas reconocidas en min√∫sculas
        const selectedBrands = Array.from(document.querySelectorAll('#brandFilterOptions input:checked'))
                                    .map(input => input.value.toLowerCase());

        const stationsOverall = [];  

        document.getElementById('loadingCard').style.display = 'none';
        
        sections.forEach((section, index) => {
            let stationsInSection = data.ListaEESSPrecio
                .filter(station => {
                    const lat = parseFloat(station["Latitud"].replace(',', '.'));
                    const lng = parseFloat(station["Longitud (WGS84)"].replace(',', '.'));
                    
                    if (!lat || !lng || (selectedFuelType !== 'all' && !station[selectedFuelType])) {
                        return false;
                    }

                    const stationBrand = station["R√≥tulo"].toLowerCase();
        const isRecognizedBrand = recognizedBrands.includes(stationBrand);
        const isOtherBrand = !isRecognizedBrand; // Cualquier gasolinera no reconocida es "Otras"

        // Verifica si la gasolinera coincide con las marcas seleccionadas o con "Otras"
        const isBrandMatch = selectedBrands.some(brand => {
            if (brand === "otras") {
                return isOtherBrand; // Si se seleccion√≥ "Otras", incluye marcas no reconocidas
            }
            return stationBrand.includes(brand);
        });

        if (selectedBrands.length > 0 && !isBrandMatch) {
            return false;
        }

                    return isPointNearRoutePart([lat, lng], section.coords);
                })
                .map(station => ({
                    ...station,
                    price: selectedFuelType === 'all' ? 
                        parseFloat(station["Precio Gasolina 95 E5"]?.replace(',', '.') || Infinity) :
                        parseFloat(station[selectedFuelType]?.replace(',', '.') || Infinity)
                }))
                .sort((a, b) => a.price - b.price);

            stationsOverall.push(...stationsInSection);

            if (totalDistance > 100) {
                stationsInSection = stationsInSection.slice(0, 6);
            }
            
            const lowestPriceInSection = Math.min(...stationsInSection.map(s => s.price));

            stationsInSection.forEach(station => {
                const lat = parseFloat(station["Latitud"].replace(',', '.'));
                const lng = parseFloat(station["Longitud (WGS84)"].replace(',', '.'));
                const isLowest = station.price === lowestPriceInSection;
                
                const marker = createStationMarker(lat, lng, isLowest, false, station["R√≥tulo"]).addTo(map);
                markers.push(marker);
                
                let popupContent = `
                    <div class="station-popup">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0;">${station["R√≥tulo"]}</h3>
                            <button class="info-button" onclick="showStationInfo('${station["R√≥tulo"]}', '${station["Direcci√≥n"]}', '${station["Horario"]}', ${JSON.stringify(station).replace(/"/g, '&quot;')}, '${selectedFuelType}')" title="M√°s informaci√≥n">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#0087c7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                            </button>
                        </div>
                        <p>${station["Direcci√≥n"]}</p>
                `;
                
                let priceText = '';
                const fuelTypes = {
                    "Precio Gasolina 95 E5": "G95",
                    "Precio Gasoleo A": "Diesel",
                    "Precio Gasolina 98 E5": "Gasoline 98 E5",
                    "Precio Gasolina 95 E5 Premium": "Gasoline 95 E5 Premium",
                    "Precio Gasoleo Premium": "Diesel Premium",
                    "Precio Hidrogeno": "Hydrogen",
                    "Precio Gas Natural Comprimido": "CNG",
                    "Precio Gas Natural Licuado": "LNG",
                    "Precio Gases licuados del petr√≥leo": "LPG",
                    "Precio Bioetanol": "Bioethanol",
                    "Precio Biodiesel": "Biodiesel"
                };

                if (selectedFuelType === 'all') {
                    for (const [key, label] of Object.entries(fuelTypes)) {
                        if (station[key]) {
                            popupContent += `<p>${label}: <span class="price">${station[key]}‚Ç¨</span></p>`;
                            priceText += `${label}: ${station[key]}‚Ç¨ `;
                        }
                    }
                } else {
                    const fuelLabels = {
                        "Precio Gasolina 95 E5": "Gasoline 95 E5",
                        "Precio Gasoleo A": "Diesel A",
                        "Precio Gasolina 98 E5": "Gasoline 98 E5",
                        "Precio Gasolina 95 E5 Premium": "Gasoline 95 E5 Premium",
                        "Precio Gasoleo Premium": "Diesel Premium",
                        "Precio Hidrogeno": "Hydrogen",
                        "Precio Gas Natural Comprimido": "CNG",
                        "Precio Gas Natural Licuado": "LNG",
                        "Precio Gases licuados del petr√≥leo": "LPG",
                        "Precio Bioetanol": "Bioethanol",
                        "Precio Biodiesel": "Biodiesel"
                    };
                    
                    if (station[selectedFuelType]) {
                        popupContent += `<p>${fuelLabels[selectedFuelType]}: <span class="price">${station[selectedFuelType]}‚Ç¨</span></p>`;
                        priceText = `${station[selectedFuelType]}‚Ç¨`;
                    }
                }
                
                popupContent += `
                    <button class="add-to-route-btn" onclick="addStationToRoute(${lat}, ${lng})">A√±adir a la Ruta</button>
                </div>`;
                marker.bindPopup(popupContent);
            });
        });

        const lowestOverallPrice = Math.min(...stationsOverall.map(s => s.price));
        stationsOverall.forEach(station => {
            if (station.price === lowestOverallPrice) {
                const lat = parseFloat(station["Latitud"].replace(',', '.'));
                const lng = parseFloat(station["Longitud (WGS84)"].replace(',', '.'));
                
                const marker = createStationMarker(lat, lng, false, true, station["R√≥tulo"]).addTo(map);
                markers.push(marker);
                
                // Add popup content for the lowest overall price station
                let popupContent = `
                    <div class="station-popup">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0;">${station["R√≥tulo"]}</h3>
                            <button class="info-button" onclick="showStationInfo('${station["R√≥tulo"]}', '${station["Direcci√≥n"]}', '${station["Horario"]}', ${JSON.stringify(station).replace(/"/g, '&quot;')}, '${selectedFuelType}')" title="M√°s informaci√≥n">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#0087c7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                            </button>
                        </div>
                        <p>${station["Direcci√≥n"]}</p>
                `;
                
                let priceText = '';
                const fuelTypes = {
                    "Precio Gasolina 95 E5": "G95",
                    "Precio Gasoleo A": "Diesel",
                    "Precio Gasolina 98 E5": "Gasoline 98 E5",
                    "Precio Gasolina 95 E5 Premium": "Gasoline 95 E5 Premium",
                    "Precio Gasoleo Premium": "Diesel Premium",
                    "Precio Hidrogeno": "Hydrogen",
                    "Precio Gas Natural Comprimido": "CNG",
                    "Precio Gas Natural Licuado": "LNG",
                    "Precio Gases licuados del petr√≥leo": "LPG",
                    "Precio Bioetanol": "Bioethanol",
                    "Precio Biodiesel": "Biodiesel"
                };

                if (selectedFuelType === 'all') {
                    for (const [key, label] of Object.entries(fuelTypes)) {
                        if (station[key]) {
                            popupContent += `<p>${label}: <span class="price">${station[key]}‚Ç¨</span></p>`;
                            priceText += `${label}: ${station[key]}‚Ç¨ `;
                        }
                    }
                } else {
                    const fuelLabels = {
                        "Precio Gasolina 95 E5": "Gasoline 95 E5",
                        "Precio Gasoleo A": "Diesel A",
                        "Precio Gasolina 98 E5": "Gasoline 98 E5",
                        "Precio Gasolina 95 E5 Premium": "Gasoline 95 E5 Premium",
                        "Precio Gasoleo Premium": "Diesel Premium",
                        "Precio Hidrogeno": "Hydrogen",
                        "Precio Gas Natural Comprimido": "CNG",
                        "Precio Gas Natural Licuado": "LNG",
                        "Precio Gases licuados del petr√≥leo": "LPG",
                        "Precio Bioetanol": "Bioethanol",
                        "Precio Biodiesel": "Biodiesel"
                    };
                    
                    if (station[selectedFuelType]) {
                        popupContent += `<p>${fuelLabels[selectedFuelType]}: <span class="price">${station[selectedFuelType]}‚Ç¨</span></p>`;
                        priceText = `${station[selectedFuelType]}‚Ç¨`;
                    }
                }
                
                popupContent += `
                    <button class="add-to-route-btn" onclick="addStationToRoute(${lat}, ${lng})">A√±adir a la Ruta</button>
                </div>`;
                marker.bindPopup(popupContent);
            }
          enableStationsListButton();
        });

    } catch (error) {
        console.error('Error loading fuel stations:', error);
        document.getElementById('loadingCard').style.display = 'none';
    }
}

function clearMap() {
    // Clear markers
    if (markers && Array.isArray(markers)) {
        markers.forEach(marker => {
            if (marker && marker.remove) {
                marker.remove();
            }
        });
        markers = [];
    }
    
    // Clear route polylines
    clearRoutePolylines();
    
    // Hide loading card
    document.getElementById('loadingCard').style.display = 'none';
}

async function calculateRoute() {
  const calculateBtn = document.getElementById('calculateRouteBtn');
  const spinner = document.getElementById('routeSpinner');

  try {
    calculateBtn.disabled = true;
    spinner.style.display = 'inline-block';

    clearMap(); // Aseg√∫rate de que elimina rutas y polil√≠neas previas del mapa

    const originAddress = document.getElementById('origin').value;
    const destinationAddress = document.getElementById('destination').value;

    const origin = await geocodeAddress(originAddress);
    const destination = await geocodeAddress(destinationAddress);

    const tempRoutingControl = L.Routing.control({
      waypoints: [
        L.latLng(origin[0], origin[1]),
        L.latLng(destination[0], destination[1])
      ],
      alternativeRoutes: true,
      routeWhileDragging: false
    });

    tempRoutingControl.on('routesfound', function(e) {
      availableRoutes = e.routes.map(route => ({
        waypoints: [
          L.latLng(origin[0], origin[1]),
          L.latLng(destination[0], destination[1])
        ],
        summary: route.summary,
        coordinates: route.coordinates
      }));

      // Por defecto: mostrar rutas con popups en el punto medio
      availableRoutes.forEach((route, index) => {
        displayRoutePreview(route, index); // Crea la polil√≠nea y el popup
      });

      // Si hay m√°s de una ruta, calcular y ajustar el popup de la ruta m√°s larga
      if (availableRoutes.length > 1) {
        const shortestRoute = availableRoutes.reduce((prev, current) =>
          prev.summary.totalTime < current.summary.totalTime ? prev : current
        );

        let maxSeparation = 0;
        let maxSeparationPoint = null;

        availableRoutes.forEach((route, index) => {
          if (route !== shortestRoute) {
            route.coordinates.forEach((coord, i) => {
              const shortestCoord = shortestRoute.coordinates[i];
              if (!shortestCoord) return;

              const distance = haversineDistance(
                coord.lat, coord.lng,
                shortestCoord.lat, shortestCoord.lng
              );

              if (distance > maxSeparation) {
                maxSeparation = distance;
                maxSeparationPoint = coord;
              }
            });

            // Si encontramos el punto de separaci√≥n m√°xima, actualizar popup
            if (maxSeparationPoint) {
              updatePopupPosition(index, maxSeparationPoint);
            }
          }
        });

        console.log(`M√°xima separaci√≥n: ${maxSeparation.toFixed(2)} km`, maxSeparationPoint);
      }
      
      // Ajustar el mapa a las rutas
      const bounds = L.latLngBounds(availableRoutes.flatMap(route => route.coordinates.map(coord => L.latLng(coord.lat, coord.lng))));
      map.fitBounds(bounds, { padding: [0, 0] }); // Agregar padding para evitar que las rutas se peguen al borde

      calculateBtn.disabled = false;
      spinner.style.display = 'none';
    });

    tempRoutingControl.route();

    // Colapsar inputs
    const routeInputs = document.querySelector('.route-inputs');
    routeInputs.classList.add('collapsed');
    document.getElementById('showFuelStations').style.display = 'none';
    document.getElementById('clearStationsBtn').style.display = 'block';
  } catch (error) {
    calculateBtn.disabled = false;
    spinner.style.display = 'none';
    alert('Error calculating route: ' + error.message);
  }
}

function updatePopupPosition(routeIndex, newLatLng) {
  const polyline = routePolylines[routeIndex];
  const popup = polyline.getPopup();

  if (popup) {
    popup.setLatLng(newLatLng);
    popup.update(); // Aseg√∫rate de que el popup se actualice visualmente
  }
}

function displayRoutePreview(route, index) {
  // Determinar si es la ruta m√°s corta
  const shortestTime = Math.min(...availableRoutes.map(r => r.summary.totalTime));
  const isShortestRoute = route.summary.totalTime === shortestTime;

  const color = '#007BFF';
  const weight = isShortestRoute ? 5 : 4; 
  const opacity = isShortestRoute ? 0.7 : 0.5;

  // Convertir tiempo total en formato legible
  const totalSeconds = route.summary.totalTime;
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.round((totalSeconds % 3600) / 60);
  const durationText = `${hours > 0 ? `${hours}h ` : ''}${minutes}min`;

  // Determinar posici√≥n del popup
  let popupLatLng = isShortestRoute
    ? route.coordinates[Math.floor(route.coordinates.length / 2)] // Punto medio para la ruta m√°s corta
    : route.maxSeparationPoint || route.coordinates[Math.floor(route.coordinates.length / 2)]; // Punto de separaci√≥n m√°xima o punto medio

  const popupContent = `
    <div style="padding: 8px; min-width: 120px; text-align: center; 
                background: ${isShortestRoute ? '#0087c7' : 'white'};
                border-radius: 6px;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 3px 0;">
        <p onclick="selectAndConfirmRoute(${index})"
           style="margin: 0; font-size: 14px; font-weight: ${isShortestRoute ? 'bold' : 'normal'}; 
                  color: ${isShortestRoute ? 'white' : '#2c3e50'}; cursor: pointer;
                  transition: opacity 0.2s;"
           onmouseover="this.style.opacity='0.8'"
           onmouseout="this.style.opacity='1'">
          ${durationText}
        </p>
        <svg onclick="selectAndConfirmRoute(${index})" 
             style="cursor: pointer; transition: transform 0.2s;" 
             onmouseover="this.style.transform='scale(1.2)'" 
             onmouseout="this.style.transform='scale(1)'"
             width="20" height="20" viewBox="0 0 24 24" 
             fill="none" 
             stroke="${isShortestRoute ? 'white' : '#2c3e50'}" 
             stroke-width="2" 
             stroke-linecap="round" 
             stroke-linejoin="round">
          <path d="M5 12h14"/>
          <path d="M12 5l7 7-7 7"/>
        </svg>
      </div>
    </div>
  `;

  // Crear y a√±adir la polil√≠nea al mapa
  const polyline = L.polyline(route.coordinates, {
    color: color,
    weight: weight,
    opacity: opacity,
    className: 'route-preview'
  }).addTo(map);

  // Crear y a√±adir el popup al mapa
  const popup = L.popup({
    closeButton: true,
    autoClose: false,
    closeOnClick: false,
    className: `route-popup ${isShortestRoute ? 'route-popup-shortest' : ''}`
  })
  .setLatLng(popupLatLng)
  .setContent(popupContent);

  polyline.bindPopup(popup).openPopup();

  // Manejar clics en la polil√≠nea para seleccionar ruta
  polyline.on('click', () => {
    selectRoute(index);
    popup.openPopup();
  });

  // Guardar la referencia a la polil√≠nea
  routePolylines.push(polyline);
}
  
// Funci√≥n para calcular distancia Haversine entre dos puntos
function haversineDistance(lat1, lng1, lat2, lng2) {
  const R = 6371; // Radio de la Tierra en km
  const toRad = deg => (deg * Math.PI) / 180;

  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);

  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c; // Resultado en kil√≥metros
}
  
function clearStations() {
  // L√≥gica para eliminar marcadores y rutas del mapa
  markers.forEach(marker => marker.remove());
  routePolylines.forEach(polyline => polyline.remove());
  markers = [];
  routePolylines = [];
  
  // Eliminar todos los elementos con class="leaflet-interactive"
  const interactiveElements = document.querySelectorAll('.leaflet-interactive');
  interactiveElements.forEach(element => element.remove());

  // Restaurar el contenedor
  const routeInputs = document.querySelector('.route-inputs');
  routeInputs.classList.remove('collapsed');
  document.getElementById('clearStationsBtn').style.display = 'none';
  document.getElementById('googleMapsBtn').style.display = 'none';
  document.getElementById('showFuelStations').style.display = 'block';
  
  // Vaciar el contenido de los inputs
  const inputs = routeInputs.querySelectorAll('input[type="search"]');
  inputs.forEach(input => input.value = '');
}

function selectAndConfirmRoute(index) {
  selectRoute(index);
  confirmRoute();
}

function clearRoutePolylines() {
  routePolylines.forEach(polyline => map.removeLayer(polyline));
  routePolylines = []; 
}

function selectRoute(index) {
    selectedRouteIndex = index;

    document.querySelectorAll('.route-option').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });

    const shortestTime = Math.min(...availableRoutes.map(r => r.summary.totalTime));

    routePolylines.forEach((polyline, i) => {
        const isShortestRoute = availableRoutes[i].summary.totalTime === shortestTime;
        polyline.setStyle({
            color: '#007BFF',
            weight: isShortestRoute ? 4 : 3, 
            opacity: isShortestRoute ? 0.7 : 0.5
        });
    });
}

function confirmRoute() {
  if (selectedRouteIndex === null) {
    alert('Selecciona una ruta primero');
    return;
  }
  
  const selectedRoute = availableRoutes[selectedRouteIndex];
  clearRoutePolylines();
  displaySelectedRoute(selectedRoute);
  
  markers.forEach(marker => map.removeLayer(marker));
  markers = [];

  const coords = selectedRoute.coordinates;
  const totalDistance = selectedRoute.summary.totalDistance / 1000;
  const sections = getSections(coords, totalDistance);
  loadFuelStationsInSections(sections, totalDistance);

  document.getElementById('googleMapsBtn').style.display = 'block';
}

function displaySelectedRoute(route) {
  document.getElementById('loadingCard').style.display = 'block';
  
  const routeLine = L.polyline(route.coordinates, {
    color: '#3498db',
    weight: 4
  }).addTo(map);
}

async function addStationToRoute(lat, lng) {
    if (!availableRoutes || !availableRoutes[selectedRouteIndex]) {
        alert('Calcula una ruta primero');
        return;
    }

    const selectedRoute = availableRoutes[selectedRouteIndex];
    const newWaypoint = L.latLng(lat, lng);

    if (!selectedRoute.waypoints) {
        alert('Selecciona una ruta v√°lida');
        return;
    }

    // Verificar si el waypoint ya existe en la ruta
    const waypointExists = selectedRoute.waypoints.some(waypoint => 
        waypoint.lat === newWaypoint.lat && waypoint.lng === newWaypoint.lng
    );

    if (waypointExists) {
        // Close all popups on the map
        map.closePopup();
        // Show success message
        const successMessage = document.createElement('div');
        successMessage.className = 'success-message';
        successMessage.textContent = 'Gasolinera a√±adida a la ruta correctamente';
        document.body.appendChild(successMessage);
    
        // Trigger animation
        setTimeout(() => successMessage.classList.add('show'), 100);
    
        // Remove message after 1.5 seconds
        setTimeout(() => {
            successMessage.classList.remove('show');
            setTimeout(() => successMessage.remove(), 300);
        }, 2500);

        // Hide loading card if it's visible
        document.getElementById('loadingCard').style.display = 'none';
        return;
    }

    // Close all popups on the map
    map.closePopup();

    // Show success message
    const successMessage = document.createElement('div');
    successMessage.className = 'success-message';
    successMessage.textContent = 'Gasolinera a√±adida a la ruta correctamente';
    document.body.appendChild(successMessage);
    
    // Trigger animation
    setTimeout(() => successMessage.classList.add('show'), 100);
    
    // Remove message after 1.5 seconds
    setTimeout(() => {
        successMessage.classList.remove('show');
        setTimeout(() => successMessage.remove(), 300);
    }, 2500);

    // Hide loading card if it's visible
    document.getElementById('loadingCard').style.display = 'none';

    // A√±adir el nuevo waypoint
    selectedRoute.waypoints.splice(selectedRoute.waypoints.length - 1, 0, newWaypoint);

    // Reordenar los waypoints seg√∫n la distancia al origen
    const origin = selectedRoute.waypoints[0];
    selectedRoute.waypoints = [origin, ...selectedRoute.waypoints.slice(1).sort((a, b) => {
        const distanceA = origin.distanceTo(a);
        const distanceB = origin.distanceTo(b);
        return distanceA - distanceB;
    })];
}
  
function enableStationsListButton() {
    const stationsListBtn = document.getElementById('stationsListBtn');
    stationsListBtn.disabled = false; // Habilitar el bot√≥n
    stationsListBtn.style.background = '#ffffff'; // Cambiar el color de fondo
    stationsListBtn.style.cursor = 'pointer'; // Cambiar el cursor
    stationsListBtn.style.opacity = '1'; // Eliminar opacidad baja
    stationsListBtn.addEventListener('click', toggleStationsModal); // Asociar el evento
}
  
function toggleStationsModal() {
    const modal = document.getElementById('stationsModal');
    modal.classList.toggle('open');

    if (modal.classList.contains('open')) {
        loadStationsList(); // Cargar la lista de gasolineras al abrir
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radio de la Tierra en km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

function getBrandLogo(stationName) {
    const brandMatches = {
        'alcampo': 'ALCAMPO.png',
        'autonetoil': 'AUTONETOIL.png',
        'avia': 'AVIA.png',
        'ballenoil': 'BALLENOIL.png',
        'bdmed': 'BDMED.png',
        'bp': 'BP.png',
        'campsa': 'CAMPSA.png',
        'carrefour': 'CARREFOUR.png',
        'cepsa': 'CEPSA.png',
        'disa': 'DISA.png',
        'e.leclerc': 'E.LECLERC.png',
        'easygas': 'EASYGAS.png',
        'eni': 'ENI.png',
        'eroski': 'EROSKI.png',
        'esso': 'ESSO.png',
        'euskadilowcost': 'EUSKADILOWCOST.png',
        'galp': 'GALP.png',
        'gasexpress': 'GASEXPRESS.png',
        'lavaplus': 'LAVAPLUS.png',
        'makro': 'MAKRO.png',
        'meroil': 'MEROIL.png',
        'nafte': 'NAFTE.png',
        'pcan': 'PCAN.png',
        'petrocat': 'PETROCAT.png',
        'petronor': 'PETRONOR.png',
        'petroprix': 'PETROPRIX.png',
        'plenoil': 'PLENOIL.png',
        'q8': 'Q8.png',
        'repsol': 'REPSOL.png',
        'shell': 'SHELL.png',
        'supeco': 'SUPECO.png',
        'texaco': 'TEXACO.png',
        'tgas': 'TGAS.png',
        'bonarea': 'BONAREA.png'
    };

    const stationNameLower = stationName.toLowerCase();
    for (const [brandKey, brandImageFile] of Object.entries(brandMatches)) {
        if (stationNameLower.includes(brandKey)) {
            return brandImageFile;
        }
    }
    return 'STD.png'; // Logo por defecto
}

async function loadStationsList() {
    try {
        console.log('Iniciando loadStationsList...');

        // Acceso al contenedor de la lista
        const stationsList = document.getElementById('stationsList');
        if (!stationsList) {
            console.error('No se encontr√≥ el elemento con id "stationsList".');
            return;
        }
        stationsList.innerHTML = ''; // Limpiar contenido previo
        console.log('Elemento stationsList encontrado y limpiado.');

        // Logs iniciales
        console.log('Marcadores actuales:', markers);
        if (!Array.isArray(markers)) {
            console.error('El objeto "markers" no es un array.');
            return;
        }
        if (markers.length === 0) {
            stationsList.innerHTML = '<p>No hay gasolineras cargadas.</p>';
            console.log('No hay marcadores en el mapa.');
            return;
        }

        // Obtener el punto de origen desde el input
        const originInput = document.getElementById('origin');
        if (!originInput || !originInput.value) {
            console.error('El campo de origen no est√° definido o est√° vac√≠o.');
            stationsList.innerHTML = '<p>Por favor, introduce un origen en el campo correspondiente.</p>';
            return;
        }

        const address = originInput.value;

        // Geocodificar la direcci√≥n
        const routePoints = { start: null };
        try {
            routePoints.start = await geocodeAddress(address);
        } catch (error) {
            console.error('Error al geocodificar la direcci√≥n:', error);
            stationsList.innerHTML = '<p>No se pudo obtener la ubicaci√≥n para la direcci√≥n ingresada.</p>';
            return;
        }

        console.log('Coordenadas del origen:', routePoints.start);

        // Verificar si se obtuvieron coordenadas
        if (!routePoints.start) {
            stationsList.innerHTML = '<p>No se pudo determinar las coordenadas del origen.</p>';
            console.error('Las coordenadas del origen no se pudieron obtener.');
            return;
        }

        // Ordenar los marcadores por distancia
        const sortedMarkers = markers.map(marker => {
            const lat = marker.getLatLng().lat;
            const lon = marker.getLatLng().lng;
            const distance = calculateDistance(routePoints.start[0], routePoints.start[1], lat, lon).toFixed(2);

            return {
                marker,
                distance: parseFloat(distance),
            };
        }).sort((a, b) => a.distance - b.distance);

        // Crear la tabla
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `
            <thead>
                <tr>
                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid #ccc;"></th>
                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid #ccc;">Gasolinera</th>
                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer;" onclick="sortTableBy('price', this)">Precio</th>
                    <th style="text-align: left; padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer;" onclick="sortTableBy('distance', this)">Distancia</th>
                    <th style="text-align: center; padding: 10px; border-bottom: 1px solid #ccc;">A√±adir</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        console.log('Tabla creada.');

        // Generar las filas ordenadas
        sortedMarkers.forEach(({ marker, distance }, index) => {
            try {
                const popup = marker.getPopup();
                if (!popup) return;

                const popupContent = popup.getContent();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = popupContent;

                const name = tempDiv.querySelector('.station-popup h3')?.textContent || 'Sin nombre';
                const rawPrice = tempDiv.querySelector('.price')?.textContent || '0';
                // Detectar formato europeo (1.439,56) y convertirlo a formato est√°ndar (1439.56)
                const normalizedPrice = rawPrice.replace(/\./g, '').replace(',', '.');
                const price = parseFloat(normalizedPrice) || 0;

                const brandLogo = getBrandLogo(name);
              
                const lat = marker.getLatLng().lat;
                const lon = marker.getLatLng().lng;

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
              
                // Acci√≥n al hacer clic en la fila
                row.onclick = () => {
                // Centrar el mapa en el marcador
                map.setView([lat, lon], 9); // Zoom predeterminado: 15
                marker.openPopup();

                // Cerrar el modal
                //toggleFullscreenModalFull(stationsModal);
                closeModal('stationsModal');
                };

                row.innerHTML = `
                    <td style="padding: 10px;"><img src="${brandLogo}" alt="${name}" style="width: 40px; height: 40px; border-radius: 8px;"></td>
                    <td style="padding: 10px;">${name}</td>
                    <td style="padding: 10px; color: #e74c3c; font-weight: bold;" data-price="${price}">${price.toFixed(3)} ‚Ç¨</td>
                    <td style="padding: 10px;" data-distance="${distance}">${distance} km</td>
                    <td style="padding: 10px; text-align: center;">
                        <button style="
                            background: #27ae60; 
                            color: white; 
                            border: none; 
                            border-radius: 4px; 
                            padding: 6px 12px; 
                            cursor: pointer;
                            font-weight: bold;
                        " onclick="addStationToRoute(${lat}, ${lon})">+</button>
                    </td>
                `;
                tbody.appendChild(row);
            } catch (error) {
                console.error(`Error procesando el marcador ${index + 1}:`, error);
            }
        });

        // A√±adir la tabla al contenedor
        stationsList.appendChild(table);
        console.log('Tabla generada correctamente.');
      document.getElementById('stationsListBtn').onclick = async () => {
    await loadStationsList(); // Carga o recarga la tabla
    openModal('stationsModal'); // Abre el modal
};

    } catch (error) {
        console.error('Error inesperado en loadStationsList:', error);
    }
}
  
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block'; // Mostrar el modal
    } else {
        console.error(`No se encontr√≥ el modal con ID: ${modalId}`);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none'; // Ocultar el modal
    } else {
        console.error(`No se encontr√≥ el modal con ID: ${modalId}`);
    }
}
  
function sortTableBy(attribute, headerElement) {
    const table = headerElement.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Determinar la direcci√≥n de orden
    const isAscending = headerElement.dataset.order !== 'asc';
    headerElement.dataset.order = isAscending ? 'asc' : 'desc';

    // Ordenar las filas
    rows.sort((a, b) => {
        const aValue = parseFloat(a.querySelector(`td[data-${attribute}]`)?.dataset[attribute]) || 0;
        const bValue = parseFloat(b.querySelector(`td[data-${attribute}]`)?.dataset[attribute]) || 0;
        return isAscending ? aValue - bValue : bValue - aValue;
    });

    // Reagregar las filas ordenadas al tbody
    rows.forEach(row => tbody.appendChild(row));
}
  
async function geocodeAddressList(address) {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Error en la solicitud de geocodificaci√≥n: ${response.statusText}`);
    }

    const data = await response.json();
    if (data.length === 0) {
        throw new Error('No se encontraron resultados para la direcci√≥n proporcionada.');
    }

    const { lat, lon } = data[0];
    return [parseFloat(lat), parseFloat(lon)];
}

function exportToGoogleMaps() {
    if (!availableRoutes) {
        alert('Calcula una ruta primero');
        return;
    }

    if (selectedRouteIndex === null) {
        if (availableRoutes.length > 0) {
            selectedRouteIndex = 0;
        } else {
            alert('No hay rutas disponibles. Calcula una nueva ruta.');
            return;
        }
    }

    const route = availableRoutes[selectedRouteIndex];
    if (!route || !route.waypoints || route.waypoints.length < 2) {
        alert('Datos de ruta no v√°lidos. Int√©ntalo de nuevo.');
        return;
    }

    let url = 'https://www.google.com/maps/dir/?api=1&travelmode=driving';
    
    url += `&origin=${route.waypoints[0].lat},${route.waypoints[0].lng}`;
    url += `&destination=${route.waypoints[route.waypoints.length-1].lat},${route.waypoints[route.waypoints.length-1].lng}`;
    
    if (route.waypoints.length > 2) {
        const middleWaypoints = route.waypoints.slice(1, -1);
        const waypointsString = middleWaypoints
            .map(wp => `${wp.lat},${wp.lng}`)
            .join('|');
        url += `&waypoints=${waypointsString}`;
    }
    
    window.open(url, '_blank');
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
    if (sidebar.classList.contains('open')) {
        document.addEventListener('click', closeSidebarOnClickOutside);
    } else {
        document.removeEventListener('click', closeSidebarOnClickOutside);
    }
  updateBrandSubtitle();
}

function closeSidebarOnClickOutside(event) {
    const sidebar = document.getElementById('sidebar');
    const menuItem = document.getElementById('menuIcon');
    const isModalOpen = document.querySelector('.fullscreen-modal.open') !== null;

    if (!isModalOpen && sidebar && !sidebar.contains(event.target) && !menuItem.contains(event.target)) {
        sidebar.classList.remove('open');
        document.removeEventListener('click', closeSidebarOnClickOutside);
    }
}

function setMapType(type) {
    // Remove existing tile layers
    Object.values(tileLayers).forEach(layer => map.removeLayer(layer));

    // Check if the selected type is Satellite, and display a warning
    if (type === 'satellite') {
        alert('El modo Sat√©lite no est√° disponible. Reviertiendo a modo est√°ndar.');
        type = 'standard'; // Revert to Standard mode
    }

    // Add the selected map type's tile layer
    if (tileLayers[type]) {
        tileLayers[type].addTo(map);
    }

    document.querySelectorAll('.map-type-option').forEach(option => {
        option.classList.toggle('selected', option.classList.contains(`${type}-option`));
    });
}

// Initialize map type to standard on load
window.addEventListener('DOMContentLoaded', () => {
    setMapType('standard');
    const initialFuelType = document.getElementById('fuelType').value;
    updateFuelTypeSubtitle(initialFuelType); // Initialize on load
    //updateBrandSubtitle(); // Initialize brand subtitle
    // Initialize all brand checkboxes to be checked on page load
    document.querySelectorAll('#brandFilterOptions input[type="checkbox"]').forEach(checkbox => checkbox.checked = true);
    // Update the brand subtitle to reflect that all are selected
    updateBrandSubtitle();
    initializeBrandFilter();
});

function showOnboardingIfFirstTime() {
  if (!localStorage.getItem('onboardingCompleted')) {
    document.getElementById('onboardingScreen').style.display = 'flex';
  } else {
    document.getElementById('onboardingScreen').style.display = 'none';
  }
}

function showStep(step) {
  document.querySelectorAll('.onboarding-step').forEach(el => {
    el.classList.remove('active');
  });
  document.getElementById(`step${step}`).classList.add('active');
  document.querySelectorAll('.fuel-option').forEach(option => {
    option.addEventListener('click', () => {
        const selectedFuelType = option.getAttribute('data-value');
        localStorage.setItem('preferredFuelType', selectedFuelType);
    });
});
  if (step === 2) {
    // A√±adir listener a cada marca
    document.querySelectorAll('.brand-option').forEach(option => {
        const brandName = option.querySelector('.brand-name')?.textContent.trim();
        if (!brandName) return; // Ignorar si no hay nombre

        option.addEventListener('click', () => {
            const isSelected = option.classList.contains('selected');

            if (isSelected) {
              // Seleccionar marca
                let selectedBrands = JSON.parse(localStorage.getItem('preferredBrands')) || [];
                selectedBrands.push(brandName);
                localStorage.setItem('preferredBrands', JSON.stringify(selectedBrands));
            } else {
                // Deseleccionar marca
                let selectedBrands = JSON.parse(localStorage.getItem('preferredBrands')) || [];
                selectedBrands = selectedBrands.filter(name => name !== brandName);
                localStorage.setItem('preferredBrands', JSON.stringify(selectedBrands));
              
            }
        });
    });
}

}
 
document.querySelectorAll('#onboardingBrands .brand-filter-item input').forEach(checkbox => {
    checkbox.addEventListener('change', updatePreferredBrands);
});

function selectFuelType(element) {
  document.querySelectorAll('.fuel-option').forEach(el => {
    el.classList.remove('selected');
  });
  element.classList.add('selected');
  document.querySelector('.next-step-btn').disabled = false;
  
  // Store selected fuel type
  const selectedFuel = element.dataset.value;
  document.getElementById('fuelType').value = selectedFuel;
}

function selectBrand(element) {
  element.classList.toggle('selected');
  // Enable/disable the start button based on selection
  const selectedBrands = document.querySelectorAll('.brand-option.selected');
  const startButton = document.querySelector('.start-app-btn');
  
  if (startButton) {
      if (selectedBrands.length === 0) {
          startButton.style.opacity = '0.5';
      } else {
          startButton.disabled = false;
          startButton.style.opacity = '1';
      }
  }
  
  // Add a subtle animation to the selected/deselected brand
  element.style.transform = 'scale(1.05)';
  setTimeout(() => {
      element.style.transform = 'scale(1)';
  }, 150);
  //---
  //---
}

function populateBrands() {
    const brandData = [
        { name: 'Alcampo', image: 'ALCAMPO.png' },
        { name: 'AutonetOil', image: 'AUTONETOIL.png' },
        { name: 'Avia', image: 'AVIA.png' },
        { name: 'Ballenoil', image: 'BALLENOIL.png' },
        { name: 'BDMED', image: 'BDMED.png' },
        { name: 'Bonarea', image: 'BONAERA.png' },
        { name: 'Bp', image: 'BP.png' },
        { name: 'Campsa', image: 'CAMPSA.png' },
        { name: 'Carrefour', image: 'CARREFOUR.png' },
        { name: 'Cepsa', image: 'CEPSA.png' },
        { name: 'Disa', image: 'DISA.png' },
        { name: 'E.leclerc', image: 'E.LECLERC.png' },
        { name: 'EasyGas', image: 'EASYGAS.png' },
        { name: 'ENI', image: 'ENI.png' },
        { name: 'Eroski', image: 'EROSKI.png' },
        { name: 'Esso', image: 'ESSO.png' },
        { name: 'EuskadiLowCost', image: 'EUSKADILOWCOST.png' },
        { name: 'Galp', image: 'GALP.png' },
        { name: 'GasExpress', image: 'GASEXPRESS.png' },
        { name: 'Lavaplus', image: 'LAVAPLUS.png' },
        { name: 'Makro', image: 'MAKRO.png' },
        { name: 'Meroil', image: 'MEROIL.png' },
        { name: 'Nafte', image: 'NAFTE.png' },
        { name: 'Pcan', image: 'PCAN.png' },
        { name: 'Petrocat', image: 'PETROCAT.png' },
        { name: 'Petronor', image: 'PETRONOR.png' },
        { name: 'Petroprix', image: 'PETROPRIX.png' },
        { name: 'Plenoil', image: 'PLENOIL.png' },
        { name: 'Q8', image: 'Q8.png' },
        { name: 'Repsol', image: 'REPSOL.png' },
        { name: 'Shell', image: 'SHELL.png' },
        { name: 'Supeco', image: 'SUPECO.png' },
        { name: 'Texaco', image: 'TEXACO.png' },
        { name: 'Tgas', image: 'TGAS.png' },
        { name: 'Otras', image: 'STD.png' }
    ];

    const container = document.getElementById('onboardingBrands');
    container.innerHTML = ''; // Clear existing content

    brandData.forEach(brand => {
        const div = document.createElement('div');
        div.className = 'brand-option';
        div.innerHTML = `
            <div class="brand-icon">
              <img src="${brand.image}" alt="${brand.name}" style="width: 25px; width: 25px; object-fit: contain;">
            </div>
            <div class="brand-name">${brand.name}</div>
        `;
        div.onclick = () => selectBrand(div);
        container.appendChild(div);
    });
}

function completeOnboarding() {
  const selectedBrands = Array.from(document.querySelectorAll('.brand-option.selected'))
    .map(el => el.textContent);
  
  // Update brand checkboxes
  document.querySelectorAll('#brandFilterOptions input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = selectedBrands.includes(checkbox.value);
  });
  
  // Save onboarding completion
  localStorage.setItem('onboardingCompleted', 'true');
  
  // Hide onboarding screen
  document.getElementById('onboardingScreen').style.display = 'none';
  
  // Update UI
  updateBrandSubtitle();
  initializeBrandFilter();
  updateFuelTypeSubtitle(document.getElementById('fuelType').value);
}
  
function restartTutorial() {
    // Eliminar el estado del tutorial del localStorage
    localStorage.removeItem('onboardingCompleted');
    localStorage.removeItem('preferredBrands');
    
    // Mostrar el tutorial desde el principio
    document.getElementById('onboardingScreen').style.display = 'flex';
    
    // Asegurarse de que el primer paso est√© activo
    document.querySelectorAll('.onboarding-step').forEach(step => step.classList.remove('active'));
    document.getElementById('welcome').classList.add('active');
}


function selectAllBrandsOnboarding() {
    document.querySelectorAll('.brand-option').forEach(brandOption => {
        if (!brandOption.classList.contains('selected')) {
            brandOption.classList.add('selected');
        }
    });
  
    // Guardar todas las marcas en localStorage
    const allBrands = Array.from(document.querySelectorAll('.brand-name')).map(el => el.textContent.trim());
    localStorage.setItem('preferredBrands', JSON.stringify(allBrands));

    // Enable start button
    const startButton = document.querySelector('.start-app-btn');
    if (startButton) {
        startButton.disabled = false;
        startButton.style.opacity = '1';
    }
}

function deselectAllBrandsOnboarding() {
    document.querySelectorAll('.brand-option').forEach(brandOption => {
        brandOption.classList.remove('selected');
    });
  
    // Eliminar todas las marcas del localStorage
    localStorage.removeItem('preferredBrands');
    
    // Disable start button
    const startButton = document.querySelector('.start-app-btn');
    if (startButton) {
        startButton.disabled = true;
        startButton.style.opacity = '0.5';
    }
}

// Add event listeners
window.addEventListener('DOMContentLoaded', () => {
  showOnboardingIfFirstTime();
  populateBrands();
  
  document.querySelectorAll('.fuel-option').forEach(option => {
    option.addEventListener('click', () => selectFuelType(option));
  });
});

function applyBrandFilter() {
    const selectedBrands = Array.from(document.querySelectorAll('#brandFilterOptions input:checked'))
                                .map(input => input.value);
    updateBrandSubtitle();
    // Guardar las marcas seleccionadas en localStorage
    localStorage.setItem('preferredBrands', JSON.stringify(selectedBrands));
    toggleFullscreenModal('modalBrandFilter');  
}

function applyTankCapacity() {
    const tankCapacity = document.getElementById('tankCapacityInput').value;
    updateTankCapacitySubtitle(tankCapacity);
    toggleFullscreenModal('modalTankCapacity');  
}

function applyFuelConsumption() {
    const fuelConsumption = document.getElementById('fuelConsumptionInput').value;
    updateFuelConsumptionSubtitle(fuelConsumption);
    toggleFullscreenModal('modalFuelConsumption');  
}

function applyStationsNumber() {
    const stationsNumber = document.getElementById('stationsNumberInput').value;
    updateStationsNumberSubtitle(stationsNumber);
    toggleFullscreenModal('modalStationsNumber');  
}

function applyFuelType() {
    const selectedFuelType = document.getElementById('fuelType').value;
    // Save preferred Fuel Type in localStorage
    localStorage.setItem('preferredFuelType', selectedFuelType);
    updateFuelTypeSubtitle(selectedFuelType);
    toggleFullscreenModal('modalFuelType'); // Keep the sidebar open
}

function updateTankCapacitySubtitle(tankCapacity) {
    const tankCapacitySubtitle = document.querySelector('.options-item:nth-child(3) .options-subtitle'); // Correct index for Tank Capacity
    if(tankCapacitySubtitle) {
        tankCapacitySubtitle.textContent = tankCapacity ? `${tankCapacity}L` : "Introduce el tama√±o del dep√≥sito";
    }
  // Save tank capacity in localStorage
    localStorage.setItem('tankCapacity', tankCapacity);
}

function updateFuelConsumptionSubtitle(fuelConsumption) {
    const fuelConsumptionSubtitle = document.querySelector('.options-item:nth-child(4) .options-subtitle'); // Correct index for Fuel Consumption
    if(fuelConsumptionSubtitle) {
        fuelConsumptionSubtitle.textContent = fuelConsumption ? `${fuelConsumption}L/100km` : "Introduce el consumo medio de tu veh√≠culo";
    }
  // Save fuel consumption in localStorage
    localStorage.setItem('fuelConsumption', fuelConsumption);
}

function updateStationsNumberSubtitle(stationsNumber) {
    const stationsNumberSubtitle = document.querySelector('.options-item:nth-child(5) .options-subtitle'); // Correct index for Fuel Consumption
    if(stationsNumberSubtitle) {
        stationsNumberSubtitle.textContent = stationsNumber ? `${stationsNumber} gasolineras` : "Introduce el n¬∫ de gasolineras para ver en tu zona";
    }
}

function updateFuelTypeSubtitle(fuelType) {
    const fuelTypeSubtitle = document.querySelector('.options-item:nth-child(1) .options-subtitle'); // Correct index for Fuel Type
    const fuelLabels = {
        "all": "Todos los tipos",
        "Precio Gasolina 95 E5": "Gasolina 95 E5",
        "Precio Gasoleo A": "Diesel A",
        "Precio Gasolina 98 E5": "Gasolina 98 E5",
        "Precio Gasolina 95 E5 Premium": "Gasolina 95 E5 Premium",
        "Precio Gasoleo Premium": "Diesel Premium",
        "Precio Hidrogeno": "Hidr√≥geno",
        "Precio Gas Natural Comprimido": "GNC",
        "Precio Gas Natural Licuado": "GNL",
        "Precio Gases licuados del petr√≥leo": "GLP",
        "Precio Bioetanol": "Bioetanol",
        "Precio Biodiesel": "Biodiesel"
    };

    if (fuelTypeSubtitle) {
        fuelTypeSubtitle.textContent = fuelLabels[fuelType] ?? "Elige el tipo de combustible";
    }
}

function updateBrandSubtitle() {
    const brandSubtitle = document.querySelector('.options-item:nth-child(2) .options-subtitle');
    const storedBrands = JSON.parse(localStorage.getItem('preferredBrands')) || []; // Obtiene marcas seleccionadas del localStorage

    if (storedBrands.length === 0) {
        // Si no hay marcas seleccionadas, mostrar "Todas las marcas"
        brandSubtitle.textContent = "Todas las marcas";
    } else {
        // Mostrar las marcas seleccionadas
        brandSubtitle.textContent = storedBrands.join(', ');
    }
}

function toggleFullscreenModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
        const wasOpen = modal.classList.contains('open');
        document.querySelectorAll('.fullscreen-modal').forEach(m => m.classList.remove('open'));
        if (!wasOpen) modal.classList.add('open');
    }
}
  
function toggleFullscreenModalFull(id) {
    const modal = document.getElementById(id);
    if (modal) {
        const wasOpen = modal.classList.contains('open');
        document.querySelectorAll('.fullscreen-modal-full').forEach(m => m.classList.remove('open'));
        if (!wasOpen) modal.classList.add('open');
    }
}

function useCurrentLocation() {
    if ("geolocation" in navigator) {
        const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        };

        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                try {
                    // Reverse geocode to get address using OpenStreetMap Nominatim
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    
                    const originInput = document.getElementById('origin');
                    if (originInput) {
                        const addressParts = [];
                        if (data.address?.road) addressParts.push(data.address.road);
                        if (data.address?.house_number) addressParts.push(data.address.house_number);
                        if (data.address?.city || data.address?.town) addressParts.push(data.address.city || data.address.town);
                        if (data.address?.postcode) addressParts.push(data.address.postcode);

                        const address = addressParts.join(', ');
                        originInput.value = address || data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                } catch (error) {
                    console.error('Error getting address:', error);
                    // Fallback to coordinates with better formatting
                    document.getElementById('origin').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
              // Centrar el mapa en la ubicaci√≥n actual del usuario
                if (typeof map !== 'undefined' && lat && lng) {
                    // Para Leaflet
                    map.setView([lat, lng], 14);

                    // Para Google Maps (comentar el c√≥digo anterior si usas esta biblioteca)
                    // map.setCenter(new google.maps.LatLng(lat, lng));
                    // map.setZoom(15);
                    
                    // Si el marcador no existe, crear un c√≠rculo azul
                    if (!userMarker) {
                        userMarker = L.circleMarker([lat, lng], {
                            radius: 10, // Tama√±o del c√≠rculo
                            color: '#007BFF', // Color del borde
                            fillColor: '#007BFF', // Color de relleno
                            fillOpacity: 0.5, // Transparencia
                        }).addTo(map).bindPopup("Tu ubicaci√≥n actual");
                    } else {
                        // Actualizar la posici√≥n del marcador
                        userMarker.setLatLng([lat, lng]);
                    }
                }
            },
            function(error) {
                let errorMessage;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Se ha denegado el acceso a la ubicaci√≥n. Habilite los servicios de ubicaci√≥n en la configuraci√≥n de su dispositivo y vuelva a intentarlo.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "No se puede determinar su ubicaci√≥n. Compruebe la configuraci√≥n de ubicaci√≥n de su dispositivo o vuelva a intentarlo m√°s tarde.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "Se agot√≥ el tiempo de espera para la solicitud de ubicaci√≥n. Verifique su conexi√≥n a Internet y vuelva a intentarlo.";
                        break;
                    default:
                        errorMessage = "Se produjo un error inesperado al obtener su ubicaci√≥n. Int√©ntelo nuevamente.";
                        break;
                }
                alert(errorMessage);
            },
            options // Add the options object to the getCurrentPosition call
        );
    } else {
        alert("Su dispositivo no admite los servicios de ubicaci√≥n. Vuelva a intentarlo o ingrese su ubicaci√≥n manualmente.");
    }
}

function reopenWelcome() { //Funcion para reabrir el tutorial
    // Reset onboarding state
    document.getElementById('onboardingScreen').style.display = 'flex';
    document.querySelectorAll('.onboarding-step').forEach(el => {
        el.classList.remove('active');
    });
    document.getElementById('welcome').classList.add('active');
}

function showStationInfo(name, address, schedule, stationData, selectedFuelType) {
    // Get tank capacity from input
    const tankCapacity = parseFloat(document.getElementById('tankCapacityInput')?.value) || 50; // Default to 50L if not set
    
    // Calculate prices and costs
    const prices = {};
    let selectedPrice = 0;
    let totalCost = 0;
    
    // Process fuel prices
    const fuelTypes = {
        "Precio Gasolina 95 E5": "Gasoline 95 E5",
        "Precio Gasoleo A": "Diesel A",
        "Precio Gasolina 98 E5": "Gasolina 98 E5",
        "Precio Gasolina 95 E5 Premium": "Gasolina 95 E5 Premium",
        "Precio Gasoleo Premium": "Diesel Premium",
        "Precio Hidrogeno": "Hidr√≥geno",
        "Precio Gas Natural Comprimido": "GNC",
        "Precio Gas Natural Licuado": "GNL",
        "Precio Gases licuados del petr√≥leo": "GLP",
        "Precio Bioetanol": "Bioetanol",
        "Precio Biodiesel": "Biodiesel"
    };

    // First, calculate selected price for this station
    Object.entries(fuelTypes).forEach(([key, label]) => {
        if (stationData[key]) {
            const price = parseFloat(stationData[key].replace(',', '.'));
            prices[label] = price;
            if (key === selectedFuelType) {
                selectedPrice = price;
                totalCost = price * tankCapacity;
            }
        }
    });

    // Calculate average price on route for the selected fuel type
    let averagePrice = 0;
    let priceCount = 0;

    if (selectedFuelType && selectedFuelType !== 'all') {
        markers.forEach(marker => {
            const popup = marker.getPopup();
            if (!popup) return;

            const content = popup._content;
            const priceRegex = new RegExp(`${fuelTypes[selectedFuelType]}: <span class="price">(\\d+(?:[.,]\\d+)?)‚Ç¨<\\/span>`);
            const match = content.match(priceRegex);
            
            if (match) {
                const price = parseFloat(match[1].replace(',', '.'));
                if (!isNaN(price)) {
                    averagePrice += price;
                    priceCount++;
                }
            }
        });
    }

    // Calculate final average
    averagePrice = priceCount > 0 ? averagePrice / priceCount : selectedPrice;
    const priceDifference = selectedPrice - averagePrice;
    const priceDifferenceText = priceDifference > 0 ? 
        `+${priceDifference.toFixed(2)}‚Ç¨ por encima de la media` : 
        `${priceDifference.toFixed(2)}‚Ç¨ por debajo de la media`;

    // Update the costAnalysisSection variable
    const costAnalysisSection = selectedFuelType && selectedFuelType !== 'all' ? 
        `<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">An√°lisis de costes</h3>
            <p><strong>Capacidad del dep√≥sito:</strong> ${tankCapacity}L</p>
            <p><strong>Coste del repostaje:</strong> ${totalCost.toFixed(2)}‚Ç¨</p>
            <p><strong>Precio medio en ruta:</strong> ${averagePrice.toFixed(3)}‚Ç¨/L</p>
            <p><strong>Diferencia de precio:</strong> <span style="color: ${priceDifference > 0 ? '#e74c3e' : '#27ae60'}">${priceDifferenceText}</span></p>
        </div>` :
        `<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">An√°lisis de costes</h3>
            <p style="color: #666; margin-bottom: 15px;">
                <svg style="vertical-align: middle; margin-right: 8px;" width="16" height="16" viewBox="0 0 24 24" fill="#666">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                Seleccione un tipo de combustible para ver un an√°lisis de costes detallado para esta estaci√≥n y recargar la ruta.
            </p>
        </div>`;

    // Create and show modal
    const modalHtml = `
        <div class="fullscreen-modal open" id="stationInfoModal" style="z-index: 2000; overflow-y:auto;">
            <div class="modal-content">
                <div style="
                    background-image: url('fondo-info.png');
                    background-size: cover;
                    background-position: center;
                    height: 200px;
                    margin: -30px -30px 20px -30px;
                    border-radius: 12px 12px 0 0;
                    position: relative;
                ">
                    <div style="
                        position: absolute;
                        bottom: 20px;
                        left: 30px;
                        margin: 0;
                    ">
                        <h2 style="
                            color: #2c3e50;
                            margin: 0;
                            font-size: 24px;
                            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
                        ">${name}</h2>
                        <p style="
                            color: #34495e;
                            margin: 5px 0 0 0;
                            font-size: 14px;
                            text-align: left;
                            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
                        ">${schedule || 'Schedule not available'}</p>
                    </div>
                </div>
                <div style="text-align: left; margin-bottom: 20px;">
                    <p style="margin: 10px 0;"><strong>Direcci√≥n:</strong><br>${address}</p>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">Precio del combustible</h3>
                        ${Object.entries(prices)
                            .map(([type, price]) => `
                                <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                    <span>${type}:</span>
                                    <span style="font-weight: bold; color: ${price === selectedPrice ? '#e74c3e' : '#2c3e50'}">${price.toFixed(3)}‚Ç¨/L</span>
                                </div>
                            `).join('')}
                    </div>

                    ${costAnalysisSection}
                </div>
                <button class="close-modal" onclick="document.getElementById('stationInfoModal').remove()">Cerrar</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}
  
// Variable global para almacenar el precio promedio
let lastAveragePrice = "N/A";

function calculateAveragePrice(stations, selectedFuelType) {
    let totalPrice = 0;
    let count = 0;

    stations.forEach(station => {
        const price = parseFloat(station[selectedFuelType]?.replace(',', '.') || 'NaN');
        if (!isNaN(price) && price > 0) {
            totalPrice += price;
            count++;
        }
    });

    const average = count > 0 ? (totalPrice / count).toFixed(3) : "N/A";
    //lastAveragePrice = average; // Actualizar la variable global
    return average;
}

// Bot√≥n 'Mostrar gasolineras'
document.querySelector('.fuel-stations-btn').addEventListener('click', () => {
    const mapBounds = map.getBounds();
    const defaultLimit = 10;
    const userLimitInput = document.querySelector('#stationsNumberInput');
    const stationLimit = userLimitInput && userLimitInput.value ? parseInt(userLimitInput.value, 10) : defaultLimit;

    document.getElementById('loadingCard').style.display = 'block';
    clearStations();

    fetch('https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/')
        .then(response => response.json())
        .then(data => {
            const stations = data.ListaEESSPrecio;
            const fuelTypeSelect = document.getElementById('fuelType');
            const selectedFuelType = fuelTypeSelect && fuelTypeSelect.value !== 'all' ? fuelTypeSelect.value : 'Precio Gasolina 95 E5';

            const visibleStations = stations
                .filter(station => {
                    const lat = parseFloat(station['Latitud'].replace(',', '.'));
                    const lng = parseFloat(station['Longitud (WGS84)'].replace(',', '.'));
                    return mapBounds.contains([lat, lng]) && station[selectedFuelType];
                })
                .map(station => ({
                    ...station,
                    price: parseFloat(station[selectedFuelType].replace(',', '.')),
                    lat: parseFloat(station['Latitud'].replace(',', '.')),
                    lng: parseFloat(station['Longitud (WGS84)'].replace(',', '.'))
                }))
                .sort((a, b) => a.price - b.price)
                .slice(0, stationLimit);

            // Actualiza el precio promedio para gasolineras visibles
            lastAveragePrice = calculateAveragePrice(visibleStations, selectedFuelType);;

            visibleStations.forEach((station, index) => {
                const isCheapest = index === 0;
                const marker = createStationMarker(
                    station.lat,
                    station.lng,
                    !isCheapest,
                    isCheapest,
                    station['R√≥tulo']
                );

                const formattedPrice = station.price.toLocaleString('es-ES', {
                    minimumFractionDigits: 3,
                    maximumFractionDigits: 3
                });

                marker.bindPopup(`
                    <div class="station-popup">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <h3 style="margin: 0;">${station["R√≥tulo"]}</h3>
                            <button class="info-button" onclick="showStationInfo1('${station["R√≥tulo"]}', '${station["Direcci√≥n"]}', '${station["Horario"]}', ${JSON.stringify(station).replace(/"/g, '&quot;')}, '${selectedFuelType}')" title="M√°s informaci√≥n">
                                <svg viewBox="0 0 24 24" fill="none" stroke="#0087c7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                            </button>
                        </div>
                        <p>${station["Direcci√≥n"]}</p>
                        <p><strong>Precio ${selectedFuelType}:</strong> <span class="price">${formattedPrice}‚Ç¨</span></p>
                    </div>
                `);

                markers.push(marker);
                marker.addTo(map);
            });

            document.getElementById('loadingCard').style.display = 'none';
            alert(`Se han encontrado ${visibleStations.length} estaciones.`);
        })
        .catch(error => {
            console.error('Error cargando las estaciones:', error);
            document.getElementById('loadingCard').style.display = 'none';
            alert('Hubo un error al cargar las estaciones.');
        });
});

// Mostrar informaci√≥n de la gasolinera (respetando el modal original)
function showStationInfo1(name, address, schedule, stationData, selectedFuelType) {
    const tankCapacity = parseFloat(document.getElementById('tankCapacityInput')?.value) || 50;
    //const selectedPrice = parseFloat(stationData[selectedFuelType].replace(',', '.'));
    //const totalCost = selectedPrice * tankCapacity;
    //const prices = {};
  
  // Calculate prices and costs
    const prices = {};
    let selectedPrice = 0;
    let totalCost = 0;

  
  // Process fuel prices
    const fuelTypes = {
        "Precio Gasolina 95 E5": "Gasoline 95 E5",
        "Precio Gasoleo A": "Diesel A",
        "Precio Gasolina 98 E5": "Gasolina 98 E5",
        "Precio Gasolina 95 E5 Premium": "Gasolina 95 E5 Premium",
        "Precio Gasoleo Premium": "Diesel Premium",
        "Precio Hidrogeno": "Hidr√≥geno",
        "Precio Gas Natural Comprimido": "GNC",
        "Precio Gas Natural Licuado": "GNL",
        "Precio Gases licuados del petr√≥leo": "GLP",
        "Precio Bioetanol": "Bioetanol",
        "Precio Biodiesel": "Biodiesel"
    };

  
  // First, calculate selected price for this station
    Object.entries(fuelTypes).forEach(([key, label]) => {
        if (stationData[key]) {
            const price = parseFloat(stationData[key].replace(',', '.'));
            prices[label] = price;
            if (key === selectedFuelType) {
                selectedPrice = price;
                totalCost = price * tankCapacity;
            }
        }
    });

    const priceDifference = lastAveragePrice !== "N/A" ? (selectedPrice - parseFloat(lastAveragePrice)).toFixed(2) : "N/A";
    const priceDifferenceText = priceDifference > 0 ? 
        `+${priceDifference}‚Ç¨ por encima de la media` : 
        `${priceDifference}‚Ç¨ por debajo de la media`;

    const costAnalysisSection = selectedFuelType && selectedFuelType !== 'all' ? 
        `<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">An√°lisis de costes</h3>
            <p><strong>Capacidad del dep√≥sito:</strong> ${tankCapacity}L</p>
            <p><strong>Coste del repostaje:</strong> ${totalCost.toFixed(2)}‚Ç¨</p>
            <p><strong>Precio medio en ruta:</strong> ${lastAveragePrice}‚Ç¨/L</p>
            <p><strong>Diferencia de precio:</strong> <span style="color: ${priceDifference > 0 ? '#e74c3e' : '#27ae60'}">${priceDifferenceText}</span></p>
        </div>` :
        `<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">An√°lisis de costes</h3>
            <p style="color: #666; margin-bottom: 15px;">
                <svg style="vertical-align: middle; margin-right: 8px;" width="16" height="16" viewBox="0 0 24 24" fill="#666">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                Seleccione un tipo de combustible para ver un an√°lisis de costes detallado para esta estaci√≥n y recargar la ruta.
            </p>
        </div>`;

    const modalHtml = `
        <div class="fullscreen-modal open" id="stationInfoModal" style="z-index: 2000; overflow-y:auto;">
            <div class="modal-content">
                <div style="
                    background-image: url('fondo-info.png');
                    background-size: cover;
                    background-position: center;
                    height: 200px;
                    margin: -30px -30px 20px -30px;
                    border-radius: 12px 12px 0 0;
                    position: relative;
                ">
                    <div style="
                        position: absolute;
                        bottom: 20px;
                        left: 30px;
                        margin: 0;
                    ">
                        <h2 style="
                            color: #2c3e50;
                            margin: 0;
                            font-size: 24px;
                            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
                        ">${name}</h2>
                        <p style="
                            color: #34495e;
                            margin: 5px 0 0 0;
                            font-size: 14px;
                            text-align: left;
                            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
                        ">${schedule || 'Schedule not available'}</p>
                    </div>
                </div>
                <div style="text-align: left; margin-bottom: 20px;">
                    <p style="margin: 10px 0;"><strong>Direcci√≥n:</strong><br>${address}</p>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">Precio del combustible</h3>
                        ${Object.entries(prices)
                            .map(([type, price]) => `
                                <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                    <span>${type}:</span>
                                    <span style="font-weight: bold; color: ${price === selectedPrice ? '#e74c3e' : '#2c3e50'}">${price.toFixed(3)}‚Ç¨/L</span>
                                </div>
                            `).join('')}
                    </div>

                    ${costAnalysisSection}
                </div>
                <button class="close-modal" onclick="document.getElementById('stationInfoModal').remove()">Cerrar</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

</script>
</body>
</html>